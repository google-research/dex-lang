<!DOCTYPE HTML>
<html><head><link rel="stylesheet" href="style.css" type="text/css"><meta charset="UTF-8"></head><body><div id="main-output"><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Dex prelude</h2>
</div></div><div class="cell"><div class="prose-block"><p>Runs before every Dex program unless an alternative is provided with <code>--prelude</code>.</p>
</div></div><div class="cell"><div class="prose-block"><p>Wrappers around primitives</p>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Unit</span> <span class="symbol">=</span> %<span class="type-name">UnitType</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">TyKind</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Effects</span> <span class="symbol">=</span> %<span class="type-name">EffKind</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Fields</span> <span class="symbol">=</span> %<span class="type-name">LabeledRowKind</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int64</span> <span class="symbol">=</span> %<span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int32</span> <span class="symbol">=</span> %<span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float64</span> <span class="symbol">=</span> %<span class="type-name">Float64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float32</span> <span class="symbol">=</span> %<span class="type-name">Float32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word8</span> <span class="symbol">=</span> %<span class="type-name">Word8</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Byte</span> <span class="symbol">=</span> <span class="type-name">Word8</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Char</span> <span class="symbol">=</span> <span class="type-name">Byte</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int</span> <span class="symbol">=</span> <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">Float32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> internalCast (b<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> b <span class="symbol">=</span> %cast b x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">F64ToF</span> (x <span class="symbol">:</span> <span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">F32ToF</span> (x <span class="symbol">:</span> <span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">FToF64</span> (x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">FToF32</span> (x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">I64ToI</span> (x <span class="symbol">:</span> <span class="type-name">Int64</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">I32ToI</span> (x <span class="symbol">:</span> <span class="type-name">Int32</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">W8ToI</span>  (x <span class="symbol">:</span> <span class="type-name">Word8</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToI64</span> (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToI32</span> (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToW8</span>  (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToF</span> (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">FToI</span> (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Add</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  add <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  sub <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  zero <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+</span>)  (d<span class="symbol">:</span><span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> add
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">-</span>)  (d<span class="symbol">:</span><span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> sub
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float64Add <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Float64</span> <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span> y<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %fadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span> y<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %fsub x y
  zero <span class="symbol">=</span> <span class="type-name">FToF64</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float32Add <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Float32</span> <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span> y<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %fadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span> y<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %fsub x y
  zero <span class="symbol">=</span> <span class="type-name">FToF32</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> int64Add <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Int64</span> <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int64</span> y<span class="symbol">:</span><span class="type-name">Int64</span><span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int64</span> y<span class="symbol">:</span><span class="type-name">Int64</span><span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToI64</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> int32Add <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Int32</span> <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int32</span> y<span class="symbol">:</span><span class="type-name">Int32</span><span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int32</span> y<span class="symbol">:</span><span class="type-name">Int32</span><span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToI32</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> word8Add <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Word8</span> <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Word8</span> y<span class="symbol">:</span><span class="type-name">Word8</span><span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Word8</span> y<span class="symbol">:</span><span class="type-name">Word8</span><span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToW8</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> unitAdd <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Unit</span> <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  zero <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> tabAdd <span class="symbol">:</span> <span class="type-name">Add</span> a <span class="symbol">?=&gt;</span> <span class="type-name">Add</span> (n<span class="symbol">=&gt;</span>a) <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Mul</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  mul <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  one <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">*</span>) (d<span class="symbol">:</span><span class="type-name">Mul</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> mul
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float64Mul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Float64</span> <span class="keyword">where</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span> y<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %fmul x y
  one <span class="symbol">=</span> <span class="type-name">FToF64</span> 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float32Mul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Float32</span> <span class="keyword">where</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span> y<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %fmul x y
  one <span class="symbol">=</span> <span class="type-name">FToF32</span> 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> int64Mul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Int64</span> <span class="keyword">where</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int64</span> y<span class="symbol">:</span><span class="type-name">Int64</span><span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> <span class="type-name">IToI64</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> int32Mul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Int32</span> <span class="keyword">where</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int32</span> y<span class="symbol">:</span><span class="type-name">Int32</span><span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> <span class="type-name">IToI32</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> word8Mul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Word8</span> <span class="keyword">where</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Word8</span> y<span class="symbol">:</span><span class="type-name">Word8</span><span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> <span class="type-name">IToW8</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> unitMul <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Unit</span> <span class="keyword">where</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  one <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Integral</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  idiv<span class="symbol">:</span> a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a
  rem<span class="symbol">:</span> a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> int64Integral <span class="symbol">:</span> <span class="type-name">Integral</span> <span class="type-name">Int64</span> <span class="keyword">where</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int64</span> y<span class="symbol">:</span><span class="type-name">Int64</span><span class="symbol">.</span> %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int64</span> y<span class="symbol">:</span><span class="type-name">Int64</span><span class="symbol">.</span> %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> int32Integral <span class="symbol">:</span> <span class="type-name">Integral</span> <span class="type-name">Int32</span> <span class="keyword">where</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int32</span> y<span class="symbol">:</span><span class="type-name">Int32</span><span class="symbol">.</span> %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int32</span> y<span class="symbol">:</span><span class="type-name">Int32</span><span class="symbol">.</span> %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> word8Integral  <span class="symbol">:</span> <span class="type-name">Integral</span> <span class="type-name">Word8</span>  <span class="keyword">where</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Word8</span>  y<span class="symbol">:</span><span class="type-name">Word8</span><span class="symbol">.</span>  %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Word8</span>  y<span class="symbol">:</span><span class="type-name">Word8</span><span class="symbol">.</span>  %irem x y
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Fractional</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  divide <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float64Fractional <span class="symbol">:</span> <span class="type-name">Fractional</span> <span class="type-name">Float64</span> <span class="keyword">where</span>
  divide <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span> y<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %fdiv x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float32Fractional <span class="symbol">:</span> <span class="type-name">Fractional</span> <span class="type-name">Float32</span> <span class="keyword">where</span>
  divide <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span> y<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %fdiv x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Basic polymorphic functions and types</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) (b<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">PairType</span> a b
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">,</span>) (x<span class="command">:a</span>) (y<span class="command">:b</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">=</span> %pair x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fst ((x<span class="symbol">,</span> _)<span class="symbol">:</span> (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> snd ((_<span class="symbol">,</span> y)<span class="symbol">:</span> (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> b <span class="symbol">=</span> y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> swap ((x<span class="symbol">,</span> y)<span class="symbol">:</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (b<span class="symbol">&amp;</span>a) <span class="symbol">=</span> (y<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&lt;&lt;</span>) (f<span class="symbol">:</span> b <span class="symbol">-&gt;</span> c) (g<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> f (g x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;&gt;&gt;</span>) (g<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) (f<span class="symbol">:</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> f (g x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">flip <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">-&gt;</span> (b <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> c) <span class="symbol">=</span> <span class="symbol">\</span>f x y<span class="symbol">.</span> f y x
</div></div><div class="cell"><div class="code-block">uncurry <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">-&gt;</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>f (x<span class="symbol">,</span>y)<span class="symbol">.</span> f x y
</div></div><div class="cell"><div class="code-block">const <span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="symbol">\</span>x _<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Vector spaces</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">VSpace</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkVSpace</span> (<span class="type-name">Add</span> a) (<span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>superclass
<span class="keyword">def</span> addFromVSpace (d<span class="symbol">:</span><span class="type-name">VSpace</span> a) <span class="symbol">:</span> <span class="type-name">Add</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkVSpace</span> addDict _ <span class="symbol">-&gt;</span> addDict
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">.*</span>)  (d<span class="symbol">:</span><span class="type-name">VSpace</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkVSpace</span> _ scale <span class="symbol">-&gt;</span> scale
</div></div><div class="cell"><div class="code-block">(<span class="symbol">*.</span>)  <span class="symbol">:</span> <span class="type-name">VSpace</span> a <span class="symbol">?=&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">=</span> flip (<span class="symbol">.*</span>)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/</span>) (_<span class="symbol">:</span><span class="type-name">VSpace</span> a) <span class="symbol">?=&gt;</span> (v<span class="command">:a</span>) (s<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> a <span class="symbol">=</span> (divide 1<span class="symbol">.</span>0 s) <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> neg (_<span class="symbol">:</span><span class="type-name">VSpace</span> a) <span class="symbol">?=&gt;</span> (v<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> (<span class="symbol">-</span>1<span class="symbol">.</span>0) <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> floatVS <span class="symbol">:</span> <span class="type-name">VSpace</span> <span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">MkVSpace</span> float32Add (<span class="symbol">*</span>)
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> tabVS  <span class="symbol">:</span> <span class="type-name">VSpace</span> a <span class="symbol">?=&gt;</span> <span class="type-name">VSpace</span> (n<span class="symbol">=&gt;</span>a) <span class="symbol">=</span> <span class="type-name">MkVSpace</span> tabAdd <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> unitVS <span class="symbol">:</span> <span class="type-name">VSpace</span> <span class="type-name">Unit</span> <span class="symbol">=</span> <span class="type-name">MkVSpace</span> unitAdd <span class="symbol">\</span>s u<span class="symbol">.</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Bool type</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="type-name">False</span>
  <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">BToW8</span> (x <span class="symbol">:</span> <span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Word8</span> <span class="symbol">=</span> %dataConTag x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">W8ToB</span> (x <span class="symbol">:</span> <span class="type-name">Word8</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> %toEnum <span class="type-name">Bool</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&amp;</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> x
  y&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> y
  <span class="type-name">W8ToB</span> <span class="symbol">$</span> %and x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">||</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> x
  y&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> y
  <span class="type-name">W8ToB</span> <span class="symbol">$</span> %or x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> not  (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> x
  <span class="type-name">W8ToB</span> <span class="symbol">$</span> %not x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Sum types</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Maybe</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span>
  <span class="type-name">Nothing</span>
  <span class="type-name">Just</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isNothing (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
  <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">True</span>
  <span class="type-name">Just</span> _ <span class="symbol">-&gt;</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> (<span class="symbol">|</span>) a<span class="symbol">:</span><span class="type-name">Type</span> b<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span>
  <span class="type-name">Left</span>  a
  <span class="type-name">Right</span> b
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> select (p<span class="symbol">:</span><span class="type-name">Bool</span>) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> <span class="keyword">case</span> p <span class="keyword">of</span>
  <span class="type-name">True</span>  <span class="symbol">-&gt;</span> x
  <span class="type-name">False</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">BToI</span> (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Int</span>  <span class="symbol">=</span> <span class="type-name">W8ToI</span> <span class="symbol">$</span> <span class="type-name">BToW8</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">BToF</span> (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">IToF</span> (<span class="type-name">BToI</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> todo (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> a <span class="symbol">=</span> %throwError a
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> throw (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> a <span class="symbol">=</span> %throwError a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Effects</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Ref</span> (r<span class="symbol">:</span><span class="type-name">Type</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Ref</span> r a
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s)       <span class="symbol">:</span> {<span class="type-name">State</span> h} s    <span class="symbol">=</span> %get  ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">:=</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s) (x<span class="command">:s</span>) <span class="symbol">:</span> {<span class="type-name">State</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span> %put  ref x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ask  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h r)       <span class="symbol">:</span> {<span class="type-name">Read</span>  h} r    <span class="symbol">=</span> %ask  ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+=</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h w) (x<span class="command">:w</span>) <span class="symbol">:</span> {<span class="type-name">Accum</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span> %tell ref x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">!</span>)  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h (n<span class="symbol">=&gt;</span>a)) (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %indexRef ref i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fstRef (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %fstRef ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sndRef (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h b <span class="symbol">=</span> %sndRef ref
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withReader
      (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (r<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
      (init<span class="command">:r</span>) (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h r <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; r) <span class="symbol">:</span> {<span class="type-name">Read</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runReader init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withAccum
      (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (w<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h w <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> w) <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; w) <span class="symbol">:</span> {<span class="type-name">Accum</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runWriter explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withState
      (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (s<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> s) <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; s) <span class="symbol">:</span> {<span class="type-name">State</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runState init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Type classes</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Eq</span>  a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkEq</span>  (a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>)
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Ord</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkOrd</span> (<span class="type-name">Eq</span> a) (a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>) (a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>)  <span class="comment">-- eq, gt, lt
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span>superclass
<span class="keyword">def</span> eqFromOrd (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">:</span> <span class="type-name">Eq</span> a <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkOrd</span> eq _ _ <span class="symbol">-&gt;</span> eq
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">==</span>) (d<span class="symbol">:</span><span class="type-name">Eq</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkEq</span> eq <span class="symbol">-&gt;</span> eq x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/=</span>) (d<span class="symbol">:</span><span class="type-name">Eq</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not <span class="symbol">$</span> x <span class="symbol">==</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;</span>)  (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkOrd</span> _ gt _  <span class="symbol">-&gt;</span> gt x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;</span>)  (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> d <span class="keyword">of</span> <span class="type-name">MkOrd</span> _ _  lt <span class="symbol">-&gt;</span> lt x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;=</span>) (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&lt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;=</span>) (d<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&gt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> float64Eq <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Float64</span> <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span> y<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %feq x y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> float32Eq <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Float32</span> <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span> y<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %feq x y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> int64Eq   <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int64</span>   y<span class="symbol">:</span><span class="type-name">Int64</span><span class="symbol">.</span>   <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> int32Eq   <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Int32</span>   y<span class="symbol">:</span><span class="type-name">Int32</span><span class="symbol">.</span>   <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> word8Eq   <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Word8</span>   y<span class="symbol">:</span><span class="type-name">Word8</span><span class="symbol">.</span>   <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> boolEq    <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Bool</span>    <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">BToW8</span> x <span class="symbol">==</span> <span class="type-name">BToW8</span> y
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> unitEq    <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Unit</span>    <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> float64Ord <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Float64</span> <span class="symbol">=</span> (<span class="type-name">MkOrd</span> float64Eq (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %fgt x y)
                                                      (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %flt x y))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> float32Ord <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Float32</span> <span class="symbol">=</span> (<span class="type-name">MkOrd</span> float32Eq (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %fgt x y)
                                                      (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %flt x y))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> int64Ord   <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> (<span class="type-name">MkOrd</span> int64Eq   (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %igt x y)
                                                      (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ilt x y))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> int32Ord   <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> (<span class="type-name">MkOrd</span> int32Eq   (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %igt x y)
                                                      (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ilt x y))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> word8Ord   <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> (<span class="type-name">MkOrd</span> word8Eq   (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %igt x y)
                                                      (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ilt x y))
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> unitOrd    <span class="symbol">:</span> <span class="type-name">Ord</span> <span class="type-name">Unit</span>    <span class="symbol">=</span> (<span class="type-name">MkOrd</span> unitEq (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>) (<span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span>
<span class="keyword">def</span> pairEq (eqA<span class="symbol">:</span> <span class="type-name">Eq</span> a)<span class="symbol">?=&gt;</span> (eqB<span class="symbol">:</span> <span class="type-name">Eq</span> b)<span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Eq</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">$</span>
  <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">==</span> y2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span>
<span class="keyword">def</span> pairOrd (ordA<span class="symbol">:</span> <span class="type-name">Ord</span> a)<span class="symbol">?=&gt;</span> (ordB<span class="symbol">:</span> <span class="type-name">Ord</span> b)<span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Ord</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">=</span>
  pairGt <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&gt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&gt;</span> y2)
  pairLt <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&lt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&lt;</span> y2)
  <span class="type-name">MkOrd</span> pairEq pairGt pairLt
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: accumulate using the True/&amp;&amp; monoid
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span>
<span class="keyword">def</span> tabEq (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (eqA<span class="symbol">:</span> <span class="type-name">Eq</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Eq</span> (n<span class="symbol">=&gt;</span>a) <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">$</span>
  <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    numDifferent <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
      snd <span class="symbol">$</span> withAccum <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
        ref <span class="symbol">+=</span> (<span class="type-name">IToF</span> (<span class="type-name">BToI</span> (xs<span class="symbol">.</span>i <span class="symbol">/=</span> ys<span class="symbol">.</span>i)))
    numDifferent <span class="symbol">==</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Transcencendental functions</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Floating</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  exp    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  exp2   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log2   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log10  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log1p  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sin    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  cos    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  tan    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sinh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  cosh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  tanh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  floor  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  ceil   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  round  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sqrt   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  pow    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  lgamma <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lbeta (_ <span class="symbol">:</span> <span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> (_ <span class="symbol">:</span> <span class="type-name">Floating</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> lgamma x <span class="symbol">+</span> lgamma y <span class="symbol">-</span> lgamma (x <span class="symbol">+</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: better numerics for very large and small values.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- Using %exp here to avoid circular definition problems.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_sinh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_cosh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv ((%exp x) <span class="symbol">+</span> (%exp (%fsub 0<span class="symbol">.</span>0 x))) 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_tanh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) ((%exp x) <span class="symbol">+</span> (%exp (%fsub 0<span class="symbol">.</span>0 x)))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: unify this with float32 functions.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_sinh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x))) (<span class="type-name">FToF64</span> 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_cosh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv ((%exp x) <span class="symbol">+</span> (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x))) (<span class="type-name">FToF64</span> 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_tanh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x))) ((%exp x) <span class="symbol">+</span> (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x)))
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float64Floating <span class="symbol">:</span> <span class="type-name">Floating</span> <span class="type-name">Float64</span> <span class="keyword">where</span>
  exp    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %exp x
  exp2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %exp2   x
  log    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %log    x
  log2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %log2   x
  log10  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %log10  x
  log1p  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %log1p  x
  sin    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %sin    x
  cos    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %cos    x
  tan    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %tan    x
  sinh   <span class="symbol">=</span> float64_sinh
  cosh   <span class="symbol">=</span> float64_cosh
  tanh   <span class="symbol">=</span> float64_tanh
  floor  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %floor  x
  ceil   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %ceil   x
  round  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %round  x
  sqrt   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %sqrt   x
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span> y<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %fpow x y
  lgamma <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float64</span><span class="symbol">.</span> %lgamma x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> float32Floating <span class="symbol">:</span> <span class="type-name">Floating</span> <span class="type-name">Float32</span> <span class="keyword">where</span>
  exp    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %exp x
  exp2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %exp2   x
  log    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %log    x
  log2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %log2   x
  log10  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %log10  x
  log1p  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %log1p  x
  sin    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %sin    x
  cos    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %cos    x
  tan    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %tan    x
  sinh   <span class="symbol">=</span> float32_sinh
  cosh   <span class="symbol">=</span> float32_cosh
  tanh   <span class="symbol">=</span> float32_tanh
  floor  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %floor  x
  ceil   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %ceil   x
  round  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %round  x
  sqrt   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %sqrt   x
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span> y<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %fpow x y
  lgamma <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Float32</span><span class="symbol">.</span> %lgamma x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Working with index sets</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Range</span> (low<span class="symbol">:</span><span class="type-name">Int</span>) (high<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">IntRange</span> low high
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Fin</span> (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">Range</span> 0 n
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ordinal (i<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %toOrdinal i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> size (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %idxSetSize n
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafeFromOrdinal (n <span class="symbol">:</span> <span class="type-name">Type</span>) (i <span class="symbol">:</span> <span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> %unsafeFromOrdinal n i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fromOrdinal (n<span class="symbol">:</span><span class="type-name">Type</span>) (i<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  <span class="keyword">case</span> (0 <span class="symbol">&lt;=</span> i) <span class="symbol">&amp;&amp;</span> (i <span class="symbol">&lt;</span> size n) <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> unsafeFromOrdinal _ i
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> throw
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> asidx (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (i<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">@</span>) (i<span class="symbol">:</span><span class="type-name">Int</span>) (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iota (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Int</span> <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want Eq and Ord for all index sets, not just `Fin n`
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span>
<span class="keyword">def</span> finEq (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> <span class="type-name">Eq</span> (<span class="type-name">Fin</span> n) <span class="symbol">=</span> <span class="type-name">MkEq</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">==</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span>
<span class="keyword">def</span> finOrd (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">?-&gt;</span> <span class="symbol">:</span> <span class="type-name">Ord</span> (<span class="type-name">Fin</span> n) <span class="symbol">=</span>
  <span class="type-name">MkOrd</span> finEq (<span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&gt;</span> ordinal y) (<span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&lt;</span> ordinal y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Misc</p>
</div></div><div class="cell"><div class="code-block">pi <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> 3<span class="symbol">.</span>141592653589793
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> id (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dup (x<span class="command">:a</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> a) <span class="symbol">=</span> (x<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> map (f<span class="command">:a</span><span class="symbol">-&gt;</span>{<span class="symbol">|</span>eff} b) (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} (n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> f xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> zip (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (ys<span class="command">:n</span><span class="symbol">=&gt;</span>b) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (xs<span class="symbol">.</span>i<span class="symbol">,</span> ys<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unzip (xys<span class="command">:n</span><span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> (map fst xys<span class="symbol">,</span> map snd xys)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fanout (n<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sq (d<span class="symbol">:</span><span class="type-name">Mul</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x <span class="symbol">*</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> abs (_<span class="symbol">:</span><span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> (_<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (x <span class="symbol">&gt;</span> zero) x (zero <span class="symbol">-</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mod (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> rem (y <span class="symbol">+</span> rem x y) y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> slice (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Int</span>) (m<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>(fromOrdinal _ (ordinal i <span class="symbol">+</span> start))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reindex (ixr<span class="symbol">:</span> b <span class="symbol">-&gt;</span> a) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>v <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> tab<span class="symbol">.</span>(ixr i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span>
  swap <span class="symbol">$</span> withState init <span class="symbol">\</span>s<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    c <span class="symbol">=</span> get s
    (c&#39;<span class="symbol">,</span> y) <span class="symbol">=</span> body i c
    s <span class="symbol">:=</span> c&#39;
    y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fold (init<span class="command">:a</span>) (body<span class="symbol">:</span>(n<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) <span class="symbol">:</span> a <span class="symbol">=</span> fst <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> (body i x<span class="symbol">,</span> ())
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reduce (identity<span class="command">:a</span>) (combine<span class="symbol">:</span>(a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  <span class="comment">-- `combine` should be a commutative and associative, and form a
</span>  <span class="comment">-- commutative monoid with `identity`
</span>  <span class="comment">-- TODO: implement with a parallelizable monoid-parameterized writer
</span>  fold identity (<span class="symbol">\</span>i c<span class="symbol">.</span> combine c xs<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: call this `scan` and call the current `scan` something else
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan&#39; (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> snd <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> dup (body i x)
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: allow tables-via-lambda and get rid of this
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fsum (xs<span class="command">:n</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> snd <span class="symbol">$</span> withAccum <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sum  (_<span class="symbol">:</span> <span class="type-name">Add</span> v) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce zero (<span class="symbol">+</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> prod (_<span class="symbol">:</span> <span class="type-name">Mul</span> v) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce one  (<span class="symbol">*</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mean (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> sum xs <span class="symbol">/</span> <span class="type-name">IToF</span> (size n)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> std (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> sqrt <span class="symbol">$</span> mean (map sq xs) <span class="symbol">-</span> sq (mean xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> any (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">False</span> (<span class="symbol">||</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> all (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">True</span>  (<span class="symbol">&amp;&amp;</span>) xs
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> applyN (n<span class="symbol">:</span><span class="type-name">Int</span>) (x<span class="command">:a</span>) (f<span class="command">:a</span> <span class="symbol">-&gt;</span> a) <span class="symbol">:</span> a <span class="symbol">=</span>
  snd <span class="symbol">$</span> withState x <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> _<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    ref <span class="symbol">:=</span> f (get ref)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linspace (n<span class="symbol">:</span><span class="type-name">Type</span>) (low<span class="symbol">:</span><span class="type-name">Float</span>) (high<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  dx <span class="symbol">=</span> (high <span class="symbol">-</span> low) <span class="symbol">/</span> <span class="type-name">IToF</span> (size n)
  <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> low <span class="symbol">+</span> <span class="type-name">IToF</span> (ordinal i) <span class="symbol">*</span> dx
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transpose (x<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> <span class="keyword">for</span> i j<span class="symbol">.</span> x<span class="symbol">.</span>j<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vdot (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (y<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> fsum <span class="symbol">\</span>i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> y<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dot (_<span class="symbol">:</span><span class="type-name">VSpace</span> v) <span class="symbol">?=&gt;</span> (s<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (vs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> sum <span class="keyword">for</span> j<span class="symbol">.</span> s<span class="symbol">.</span>j <span class="symbol">.*</span> vs<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- matmul. Better symbol to use? `@`?
</span></div></div><div class="cell"><div class="code-block">(<span class="symbol">**</span>) <span class="symbol">:</span> (l<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (l<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
  y&#39; <span class="symbol">=</span> transpose y
  <span class="keyword">for</span> i k<span class="symbol">.</span> fsum <span class="symbol">\</span>j<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y&#39;<span class="symbol">.</span>k<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">(<span class="symbol">**.</span>) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> <span class="symbol">\</span>mat v<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> vdot mat<span class="symbol">.</span>i v
</div></div><div class="cell"><div class="code-block">(<span class="symbol">.**</span>) <span class="symbol">:</span> (m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> flip (<span class="symbol">**.</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> inner (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (mat<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (y<span class="command">:m</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  fsum <span class="symbol">\</span>(i<span class="symbol">,</span>j)<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> mat<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Functions for working with the pseudorandom number generator</p>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: newtype
</span></div></div><div class="cell"><div class="code-block"><span class="type-name">Key</span> <span class="symbol">=</span> <span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> hash (x<span class="symbol">:</span><span class="type-name">Key</span>) (y<span class="symbol">:</span><span class="type-name">Int32</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span>
  y64 <span class="symbol">=</span> <span class="type-name">IToI64</span> y
  %ffi threefry2x32 <span class="type-name">Int64</span> x y64
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> newKey (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash (<span class="type-name">IToI64</span> 0) x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> splitKey (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> (<span class="type-name">Key</span> <span class="symbol">&amp;</span> <span class="type-name">Key</span>) <span class="symbol">=</span> (hash k 0<span class="symbol">,</span> hash k 1)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> splitKey3 (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> (<span class="type-name">Key</span> <span class="symbol">&amp;</span> <span class="type-name">Key</span> <span class="symbol">&amp;</span> <span class="type-name">Key</span>) <span class="symbol">=</span>
  (k1<span class="symbol">,</span> k&#39;) <span class="symbol">=</span> splitKey k
  (k2<span class="symbol">,</span> k3) <span class="symbol">=</span> splitKey k&#39;
  (k1<span class="symbol">,</span> k2<span class="symbol">,</span> k3)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> many (f<span class="symbol">:</span><span class="type-name">Key</span><span class="symbol">-&gt;</span>a) (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) <span class="symbol">:</span> a <span class="symbol">=</span> f (hash k (ordinal i))
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash k (ordinal i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey2 (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) (j<span class="command">:m</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash (hash k (ordinal i)) (ordinal j)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">F64ToF</span> <span class="symbol">$</span> %ffi randunif <span class="type-name">Float64</span> k
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randVec (n<span class="symbol">:</span><span class="type-name">Int</span>) (f<span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a) (k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span> f (ixkey k i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randMat (n<span class="symbol">:</span><span class="type-name">Int</span>) (m<span class="symbol">:</span><span class="type-name">Int</span>) (f<span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a) (k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Fin</span> m <span class="symbol">=&gt;</span> a <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> f (ixkey2 k i j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randn (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  (k1<span class="symbol">,</span> k2) <span class="symbol">=</span> splitKey k
  u1 <span class="symbol">=</span> rand k1
  u2 <span class="symbol">=</span> rand k2
  sqrt ((<span class="symbol">-</span>2<span class="symbol">.</span>0) <span class="symbol">*</span> log u1) <span class="symbol">*</span> cos (2<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">*</span> u2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randIdx (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  unif <span class="symbol">=</span> rand k
  fromOrdinal n <span class="symbol">$</span> <span class="type-name">FToI</span> <span class="symbol">$</span> floor <span class="symbol">$</span> unif <span class="symbol">*</span> <span class="type-name">IToF</span> (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Make this better...
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randInt (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> (<span class="type-name">I64ToI</span> k) `mod` 2147483647
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> bern (p<span class="symbol">:</span><span class="type-name">Float</span>) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rand k <span class="symbol">&lt;</span> p
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randnVec (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> randn (ixkey k i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>min / max etc</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&lt;</span> f y) x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maxBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&gt;</span> f y) x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (x1<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> minBy id x1 x2
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> max (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (x1<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> maxBy id x1 x2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimumBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (minBy f) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximumBy (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (maxBy f) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimum (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> minimumBy id xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximum (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> maximumBy id xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmin (_<span class="symbol">:</span><span class="type-name">Ord</span> o) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span>
  zeroth <span class="symbol">=</span> (0<span class="symbol">@</span>_<span class="symbol">,</span> xs<span class="symbol">.</span>(0<span class="symbol">@</span>_))
  compare <span class="symbol">=</span> <span class="symbol">\</span>(idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)<span class="symbol">.</span>
    select (x1 <span class="symbol">&lt;</span> x2) (idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)
  zipped <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (i<span class="symbol">,</span> xs<span class="symbol">.</span>i)
  fst <span class="symbol">$</span> reduce zeroth compare zipped
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> clip (_<span class="symbol">:</span><span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> ((low<span class="symbol">,</span>high)<span class="symbol">:</span>(a<span class="symbol">&amp;</span>a)) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  min high <span class="symbol">$</span> max low x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Automatic differentiation</p>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: add vector space constraints
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linearize (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> a <span class="symbol">--</span>o b) <span class="symbol">=</span> %linearize f x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> jvp (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">--</span>o b <span class="symbol">=</span> snd (linearize f x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transposeLinear (f<span class="command">:a</span> <span class="symbol">--</span>o b) <span class="symbol">:</span> b <span class="symbol">--</span>o a <span class="symbol">=</span> %linearTranspose f
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vjp (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> b <span class="symbol">--</span>o a) <span class="symbol">=</span>
  (y<span class="symbol">,</span> df) <span class="symbol">=</span> linearize f x
  (y<span class="symbol">,</span> transposeLinear df)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> grad (f<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deriv (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> jvp f x 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> derivRev (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasAllClose</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  allclose <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasDefaultTolerance</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  atol <span class="symbol">:</span> a
  rtol <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">~~</span>) (_<span class="symbol">:</span><span class="type-name">HasAllClose</span> a) <span class="symbol">?=&gt;</span> (d<span class="symbol">:</span><span class="type-name">HasDefaultTolerance</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> allclose atol rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> allCloseF32 <span class="symbol">:</span> <span class="type-name">HasAllClose</span> <span class="type-name">Float32</span> <span class="keyword">where</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol x y<span class="symbol">.</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> allCloseF64 <span class="symbol">:</span> <span class="type-name">HasAllClose</span> <span class="type-name">Float64</span> <span class="keyword">where</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol x y<span class="symbol">.</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> defaultToleranceF32 <span class="symbol">:</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Float32</span> <span class="keyword">where</span>
  atol <span class="symbol">=</span> <span class="type-name">FToF32</span> 0<span class="symbol">.</span>00001
  rtol <span class="symbol">=</span> <span class="type-name">FToF32</span> 0<span class="symbol">.</span>0001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> defaultToleranceF64 <span class="symbol">:</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Float64</span> <span class="keyword">where</span>
  atol <span class="symbol">=</span> <span class="type-name">FToF64</span> 0<span class="symbol">.</span>00000001
  rtol <span class="symbol">=</span> <span class="type-name">FToF64</span> 0<span class="symbol">.</span>00001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> allCloseTable <span class="symbol">:</span> <span class="type-name">HasAllClose</span> t <span class="symbol">?=&gt;</span> <span class="type-name">HasDefaultTolerance</span> t <span class="symbol">?=&gt;</span> <span class="type-name">HasAllClose</span> (n<span class="symbol">=&gt;</span>t) <span class="keyword">where</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol a b<span class="symbol">.</span> all <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> (a<span class="symbol">.</span>i <span class="symbol">~~</span> b<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> defaultToleranceTable <span class="symbol">:</span> (<span class="type-name">HasDefaultTolerance</span> t) <span class="symbol">?=&gt;</span> <span class="type-name">HasDefaultTolerance</span> (n<span class="symbol">=&gt;</span>t) <span class="keyword">where</span>
  atol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> atol
  rtol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> rtol
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> checkDerivBase (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  eps <span class="symbol">=</span> 0<span class="symbol">.</span>01
  ansFwd  <span class="symbol">=</span> deriv    f x
  ansRev  <span class="symbol">=</span> derivRev f x
  ansNumeric <span class="symbol">=</span> (f (x <span class="symbol">+</span> eps) <span class="symbol">-</span> f (x <span class="symbol">-</span> eps)) <span class="symbol">/</span> (2<span class="symbol">.</span> <span class="symbol">*</span> eps)
  ansFwd <span class="symbol">~~</span> ansNumeric <span class="symbol">&amp;&amp;</span> ansRev <span class="symbol">~~</span> ansNumeric
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> checkDeriv (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  checkDerivBase f x <span class="symbol">&amp;&amp;</span> checkDerivBase (deriv f) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Control flow</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> while
    (eff<span class="symbol">:</span><span class="type-name">Effects</span>) <span class="symbol">?-&gt;</span>
    (cond<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Bool</span>)
    (body<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Unit</span>)
    <span class="symbol">:</span> {<span class="symbol">|</span>eff} <span class="type-name">Unit</span> <span class="symbol">=</span>
  cond&#39; <span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Word8</span> <span class="symbol">=</span> <span class="symbol">\</span>_<span class="symbol">.</span> <span class="type-name">BToW8</span> <span class="symbol">$</span> cond ()
  %while cond&#39; body
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Vector support</p>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Reenable vector suport once fixed-width types are supported.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def UNSAFEFromOrdinal (n : Type) (i : Int) : n = %unsafeAsIndex n i
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- VectorWidth = 4  -- XXX: Keep this synced with the constant defined in Array.hs
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- VectorFloat  = todo
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- def packVector (a : Float) (b : Float) (c : Float) (d : Float) : VectorFloat = %vectorPack a b c d
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def indexVector (v : VectorFloat) (i : Fin VectorWidth) : Float = %vectorIndex v i
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- -- NB: Backends should be smart enough to optimize this to a vector load from v
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def loadVector (v : (Fin VectorWidth)=&gt;Float) : VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   idx = Fin VectorWidth
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   (packVector v.(UNSAFEFromOrdinal idx 0)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--               v.(UNSAFEFromOrdinal idx 1)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--               v.(UNSAFEFromOrdinal idx 2)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--               v.(UNSAFEFromOrdinal idx 3))
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def storeVector (v : VectorFloat) : (Fin VectorWidth)=&gt;Float =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   idx = Fin VectorWidth
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   [ indexVector v (UNSAFEFromOrdinal idx 0)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   , indexVector v (UNSAFEFromOrdinal idx 1)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   , indexVector v (UNSAFEFromOrdinal idx 2)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   , indexVector v (UNSAFEFromOrdinal idx 3) ]
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- def broadcastVector (v : Float) : VectorFloat = packVector v v v v
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- @instance vectorFloatAdd : Add VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   (MkAdd ( \x y. %vfadd x y )
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--          ( \x y. %vfsub x y )
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--          ( broadcastVector zero ))
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- @instance vectorFloatMul : Mul VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   MkMul (\x y. %vfmul x y) $ packVector 1.0 1.0 1.0 1.0
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- @instance vectorFloatVSpace : VSpace VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   MkVSpace vectorFloatAdd \x v. broadcastVector x * v
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Tiling</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Tile</span> (n <span class="symbol">:</span> <span class="type-name">Type</span>) (m <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">IndexSlice</span> n m
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- One can think of instances of `Tile n m` as injective functions `m -&gt; n`,
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- with the special property that consecutive elements of m map to consecutive
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- elements of n. In this view (+&gt;) is just function application, while ++&gt;
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- is currying followed by function application. We cannot represent currying
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- in isolation, because `Tile n (Tile u v)` does not make sense, unlike `Tile n (u &amp; v)`.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+&gt;</span>) (l <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (t<span class="symbol">:</span><span class="type-name">Tile</span> n l) (i <span class="symbol">:</span> l) <span class="symbol">:</span> n <span class="symbol">=</span> %sliceOffset t i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">++&gt;</span>) (t <span class="symbol">:</span> <span class="type-name">Tile</span> n (u <span class="symbol">&amp;</span> v)) (i <span class="symbol">:</span> u) <span class="symbol">:</span> <span class="type-name">Tile</span> n v <span class="symbol">=</span> %sliceCurry t i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile  (l <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
          (fTile <span class="symbol">:</span> (t<span class="symbol">:</span>(<span class="type-name">Tile</span> n l) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} l<span class="symbol">=&gt;</span>a))
          (fScalar <span class="symbol">:</span> n <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> %tiled fTile fScalar
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile1 (n <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (l <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (m <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
          (fTile <span class="symbol">:</span> (t<span class="symbol">:</span>(<span class="type-name">Tile</span> n l) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>l<span class="symbol">=&gt;</span>a))
          (fScalar <span class="symbol">:</span> n <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> %tiledd fTile fScalar
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: This should become just `loadVector $ for i. arr.(t +&gt; i)`
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--       once we are able to eliminate temporary arrays. Until then, we inline for performance...
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span><span class="keyword">def</span> loadTile (t <span class="symbol">:</span> <span class="type-name">Tile</span> n (<span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>)) (arr <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">VectorFloat</span> <span class="symbol">=</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">--  idx = Fin VectorWidth
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--  (packVector arr.(t +&gt; UNSAFEFromOrdinal idx 0)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--              arr.(t +&gt; UNSAFEFromOrdinal idx 1)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--              arr.(t +&gt; UNSAFEFromOrdinal idx 2)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--              arr.(t +&gt; UNSAFEFromOrdinal idx 3))
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Numerical utilities</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsumexp (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  m <span class="symbol">+</span> (log <span class="symbol">$</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsoftmax (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  lse <span class="symbol">=</span> logsumexp x
  <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">-</span> lse
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> softmax (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  e <span class="symbol">=</span>  <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m)
  s <span class="symbol">=</span> sum e
  <span class="keyword">for</span> i<span class="symbol">.</span> e<span class="symbol">.</span>i <span class="symbol">/</span> s
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> evalpoly (_<span class="symbol">:</span><span class="type-name">VSpace</span> v) <span class="symbol">?=&gt;</span> (coefficients<span class="command">:n</span><span class="symbol">=&gt;</span>v) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> v <span class="symbol">=</span>
  <span class="comment">-- Evaluate a polynomial at x.  Same as Numpy&#39;s polyval.
</span>  fold zero <span class="symbol">\</span>i c<span class="symbol">.</span> coefficients<span class="symbol">.</span>i <span class="symbol">+</span> x <span class="symbol">.*</span> c
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><p>Monoid</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Monoid</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  mempty <span class="symbol">:</span> a
  mcombine <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a  <span class="comment">-- can&#39;t use `&lt;&gt;` just for parser reasons?
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">(<span class="symbol">&lt;&gt;</span>) <span class="symbol">:</span> <span class="type-name">Monoid</span> a <span class="symbol">?=&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> mcombine
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Length-erased lists</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">List</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span>
  <span class="type-name">AsList</span> n<span class="symbol">:</span><span class="type-name">Int</span> foo<span class="symbol">:</span>(<span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> monoidList <span class="symbol">:</span> <span class="type-name">Monoid</span> (<span class="type-name">List</span> a) <span class="keyword">where</span>
  mempty <span class="symbol">=</span> <span class="type-name">AsList</span> _ []
  mcombine <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
    (<span class="type-name">AsList</span> nx xs) <span class="symbol">=</span> x
    (<span class="type-name">AsList</span> ny ys) <span class="symbol">=</span> y
    nz <span class="symbol">=</span> nx <span class="symbol">+</span> ny
    <span class="type-name">AsList</span> _ <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nz)<span class="symbol">.</span>
      i&#39; <span class="symbol">=</span> ordinal i
      <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> nx <span class="keyword">of</span>
        <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs<span class="symbol">.</span>(unsafeFromOrdinal _ i&#39;)
        <span class="type-name">False</span> <span class="symbol">-&gt;</span> ys<span class="symbol">.</span>(unsafeFromOrdinal _ (i&#39; <span class="symbol">-</span> nx))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Isomorphisms</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Iso</span> a<span class="symbol">:</span><span class="type-name">Type</span> b<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">MkIso</span> { fwd<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">&amp;</span> bwd<span class="symbol">:</span> b <span class="symbol">-&gt;</span> a }
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> appIso (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (x<span class="command">:a</span>) <span class="symbol">:</span> b <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}) <span class="symbol">=</span> iso
  fwd x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> flipIso (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) <span class="symbol">:</span> <span class="type-name">Iso</span> b a <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}) <span class="symbol">=</span> iso
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>bwd<span class="symbol">,</span> bwd<span class="symbol">=</span>fwd}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> revIso (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (x<span class="command">:b</span>) <span class="symbol">:</span> a <span class="symbol">=</span> appIso (flipIso iso) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">idIso <span class="symbol">:</span> <span class="type-name">Iso</span> a a <span class="symbol">=</span> <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>id<span class="symbol">,</span> bwd<span class="symbol">=</span>id}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&gt;&gt;</span>) (iso1<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (iso2<span class="symbol">:</span> <span class="type-name">Iso</span> b c) <span class="symbol">:</span> <span class="type-name">Iso</span> a c <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>fwd1<span class="symbol">,</span> bwd<span class="symbol">=</span>bwd1}) <span class="symbol">=</span> iso1
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>fwd2<span class="symbol">,</span> bwd<span class="symbol">=</span>bwd2}) <span class="symbol">=</span> iso2
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>(fwd1 <span class="symbol">&gt;&gt;&gt;</span> fwd2)<span class="symbol">,</span> bwd<span class="symbol">=</span>(bwd1 <span class="symbol">&lt;&lt;&lt;</span> bwd2)}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&lt;&amp;</span>) (iso2<span class="symbol">:</span> <span class="type-name">Iso</span> b c) (iso1<span class="symbol">:</span> <span class="type-name">Iso</span> a b) <span class="symbol">:</span> <span class="type-name">Iso</span> a c <span class="symbol">=</span> iso1 <span class="symbol">&amp;&gt;&gt;</span> iso2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Lens-like accessors
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- (note: #foo is an Iso {foo: a &amp; ...b} (a &amp; {&amp;...b}))
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> getAt  (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">=</span> fst <span class="symbol">&lt;&lt;&lt;</span> appIso iso
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> popAt  (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> snd <span class="symbol">&lt;&lt;&lt;</span> appIso iso
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> pushAt (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (x<span class="command">:b</span>) (r<span class="command">:c</span>) <span class="symbol">:</span> a <span class="symbol">=</span> revIso iso (x<span class="symbol">,</span> r)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> setAt  (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (x<span class="command">:b</span>) (r<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  pushAt iso x <span class="symbol">$</span> popAt iso r
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Prism-like accessors
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- (note: #?foo is an Iso {foo: a | ...b} (a | {|...b}))
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> matchWith (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c)) (x<span class="symbol">:</span> a) <span class="symbol">:</span> <span class="type-name">Maybe</span> b <span class="symbol">=</span>
  <span class="keyword">case</span> appIso iso x <span class="keyword">of</span>
    <span class="type-name">Left</span> x <span class="symbol">-&gt;</span> <span class="type-name">Just</span> x
    <span class="type-name">Right</span> _ <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> buildWith (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c)) (x<span class="symbol">:</span> b) <span class="symbol">:</span> a <span class="symbol">=</span> revIso iso <span class="symbol">$</span> <span class="type-name">Left</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">swapPairIso <span class="symbol">:</span> <span class="type-name">Iso</span> (a <span class="symbol">&amp;</span> b) (b <span class="symbol">&amp;</span> a) <span class="symbol">=</span>
  <span class="type-name">MkIso</span> {fwd <span class="symbol">=</span> <span class="symbol">\</span>(a<span class="symbol">,</span> b)<span class="symbol">.</span> (b<span class="symbol">,</span> a)<span class="symbol">,</span> bwd <span class="symbol">=</span> <span class="symbol">\</span>(b<span class="symbol">,</span> a)<span class="symbol">.</span> (a<span class="symbol">,</span> b)}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Complement the focus of a lens-like isomorphism
</span></div></div><div class="cell"><div class="code-block">exceptLens <span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c) <span class="symbol">-&gt;</span> <span class="type-name">Iso</span> a (c <span class="symbol">&amp;</span> b) <span class="symbol">=</span> <span class="symbol">\</span>iso<span class="symbol">.</span> iso <span class="symbol">&amp;&gt;&gt;</span> swapPairIso
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">swapEitherIso <span class="symbol">:</span> <span class="type-name">Iso</span> (a <span class="symbol">|</span> b) (b <span class="symbol">|</span> a) <span class="symbol">=</span>
  fwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span> l <span class="symbol">-&gt;</span> <span class="type-name">Right</span> l
    <span class="type-name">Right</span> r <span class="symbol">-&gt;</span> <span class="type-name">Left</span> r
  bwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span> r <span class="symbol">-&gt;</span> <span class="type-name">Right</span> r
    <span class="type-name">Right</span> l <span class="symbol">-&gt;</span> <span class="type-name">Left</span> l
  <span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Complement the focus of a prism-like isomorphism
</span></div></div><div class="cell"><div class="code-block">exceptPrism <span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c) <span class="symbol">-&gt;</span> <span class="type-name">Iso</span> a (c <span class="symbol">|</span> b) <span class="symbol">=</span> <span class="symbol">\</span>iso<span class="symbol">.</span> iso <span class="symbol">&amp;&gt;&gt;</span> swapEitherIso
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Use a lens-like iso to split a 1d table into a 2d table
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> overLens (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> (b<span class="symbol">=&gt;</span>c<span class="symbol">=&gt;</span>v) <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> tab<span class="symbol">.</span>(revIso iso (i<span class="symbol">,</span> j))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Zipper isomorphisms to easily specify many record/variant fields:
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- #&amp;foo is an Iso ({&amp;...l} &amp; {foo:a &amp; ...r}) ({foo:a &amp; ...l} &amp; {&amp;...r})
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- #|foo is an Iso ({|...l} | {foo:a | ...r}) ({foo:a | ...l} | {|...r})
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Convert a record zipper isomorphism to a normal lens-like isomorphism
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- by using splitR &amp;&gt;&gt; iso
</span></div></div><div class="cell"><div class="code-block">splitR <span class="symbol">:</span> <span class="type-name">Iso</span> a ({<span class="symbol">&amp;</span>} <span class="symbol">&amp;</span> a) <span class="symbol">=</span> <span class="type-name">MkIso</span> {fwd<span class="symbol">=\</span>x<span class="symbol">.</span> ({}<span class="symbol">,</span> x)<span class="symbol">,</span> bwd<span class="symbol">=\</span>({}<span class="symbol">,</span> x)<span class="symbol">.</span> x}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> overFields (iso<span class="symbol">:</span> <span class="type-name">Iso</span> ({<span class="symbol">&amp;</span>} <span class="symbol">&amp;</span> a) (b <span class="symbol">&amp;</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>c<span class="symbol">=&gt;</span>v <span class="symbol">=</span>
  overLens (splitR <span class="symbol">&amp;&gt;&gt;</span> iso) tab
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Convert a variant zipper isomorphism to a normal prism-like isomorphism
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- by using splitV &amp;&gt;&gt; iso
</span></div></div><div class="cell"><div class="code-block">splitV <span class="symbol">:</span> <span class="type-name">Iso</span> a ({<span class="symbol">|</span>} <span class="symbol">|</span> a) <span class="symbol">=</span>
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=\</span>x<span class="symbol">.</span> <span class="type-name">Right</span> x<span class="symbol">,</span> bwd<span class="symbol">=\</span>v<span class="symbol">.</span> <span class="keyword">case</span> v <span class="keyword">of</span> <span class="type-name">Right</span> x <span class="symbol">-&gt;</span> x}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sliceFields (iso<span class="symbol">:</span> <span class="type-name">Iso</span> ({<span class="symbol">|</span>} <span class="symbol">|</span> a) (b <span class="symbol">|</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>v <span class="symbol">=</span>
  reindex (buildWith <span class="symbol">$</span> splitV <span class="symbol">&amp;&gt;&gt;</span> iso) tab
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Strings and Characters</h2>
</div></div><div class="cell"><div class="code-block"><span class="type-name">String</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">List</span> <span class="type-name">Char</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">CharPtr</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">CharPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO. This is ASCII code point. It really should be Int32 for Unicode codepoint
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> codepoint (c<span class="symbol">:</span><span class="type-name">Char</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> <span class="type-name">W8ToI</span> c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Show</span> a<span class="symbol">:</span><span class="type-name">Type</span> <span class="keyword">where</span>
  show <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">String</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> showInt32 <span class="symbol">:</span> <span class="type-name">Show</span> <span class="type-name">Int32</span> <span class="keyword">where</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span> <span class="type-name">Int32</span><span class="symbol">.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showInt32 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">CharPtr</span>) x
    <span class="type-name">AsList</span> n <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
      %ptrLoad (%ptrOffset ptr (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> showInt64 <span class="symbol">:</span> <span class="type-name">Show</span> <span class="type-name">Int64</span> <span class="keyword">where</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span> <span class="type-name">Int64</span><span class="symbol">.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showInt64 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">CharPtr</span>) x
    <span class="type-name">AsList</span> n <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
      %ptrLoad (%ptrOffset ptr (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> showFloat32 <span class="symbol">:</span> <span class="type-name">Show</span> <span class="type-name">Float32</span> <span class="keyword">where</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span> <span class="type-name">Float32</span><span class="symbol">.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showFloat32 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">CharPtr</span>) x
    <span class="type-name">AsList</span> n <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
      %ptrLoad (%ptrOffset ptr (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> showFloat64 <span class="symbol">:</span> <span class="type-name">Show</span> <span class="type-name">Float64</span> <span class="keyword">where</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span> <span class="type-name">Float64</span><span class="symbol">.</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showFloat64 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">CharPtr</span>) x
    <span class="type-name">AsList</span> n <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
      %ptrLoad (%ptrOffset ptr (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- pipe-like reverse function application
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">|&gt;</span>) (x<span class="command">:a</span>) (f<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) <span class="symbol">:</span> b <span class="symbol">=</span> f x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Floating point helper functions</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sign (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> 1<span class="symbol">.</span>0
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="symbol">-</span>1<span class="symbol">.</span>0
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> copysign (a<span class="symbol">:</span><span class="type-name">Float</span>) (b<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> b <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> a
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> b <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> (<span class="symbol">-</span>a)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block">infinity <span class="symbol">=</span> 1<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">nan      <span class="symbol">=</span> 0<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isinf (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (x <span class="symbol">==</span> infinity) <span class="symbol">||</span> (x <span class="symbol">==</span> <span class="symbol">-</span>infinity)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isnan (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not (x <span class="symbol">&gt;=</span> x <span class="symbol">&amp;&amp;</span> x <span class="symbol">&lt;=</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE-754R 5.11: Floating Point Comparison Relation cmpUnordered.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> either_is_nan (x<span class="symbol">:</span><span class="type-name">Float</span>) (y<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (isnan x) <span class="symbol">||</span> (isnan y)
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Trigonometric functions.</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan_inner (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- From &quot;Computing accurate Horner form approximations to
</span>  <span class="comment">-- special functions in finite precision arithmetic&quot;
</span>  <span class="comment">-- https://arxiv.org/abs/1508.03211
</span>  <span class="comment">-- Only accurate in the range [-1, 1]
</span>  s <span class="symbol">=</span> x <span class="symbol">*</span> x
  r <span class="symbol">=</span> 0<span class="symbol">.</span>0027856871
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0158660002
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>042472221
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0749753043
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>106448799
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>142070308
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>199934542
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>333331466
  r <span class="symbol">=</span> r <span class="symbol">*</span> s
  r <span class="symbol">*</span> x <span class="symbol">+</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min_and_max (_<span class="symbol">:</span> <span class="type-name">Ord</span> a) <span class="symbol">?=&gt;</span> (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> a) <span class="symbol">=</span>
  select (x <span class="symbol">&lt;</span> y) (x<span class="symbol">,</span> y) (y<span class="symbol">,</span> x)  <span class="comment">-- get both with one comparison.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan2 (y<span class="symbol">:</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- Based off of the Tensorflow implementation at
</span>  <span class="comment">-- github.com/tensorflow/mlir-hlo/blob/master/lib/
</span>  <span class="comment">-- Dialect/mhlo/transforms/legalize_trigonometric_to_approximation.cc#L147
</span>  <span class="comment">-- With a fix to the nan propagation.
</span>  abs_x <span class="symbol">=</span> abs x
  abs_y <span class="symbol">=</span> abs y
  (min_abs_x_y<span class="symbol">,</span> max_abs_x_y) <span class="symbol">=</span> min_and_max abs_x abs_y
  a <span class="symbol">=</span> atan_inner (min_abs_x_y <span class="symbol">/</span> max_abs_x_y)
  a <span class="symbol">=</span> select (abs_x <span class="symbol">&lt;=</span> abs_y) ((pi <span class="symbol">/</span> 2<span class="symbol">.</span>0) <span class="symbol">-</span>a) a
  a <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) pi a
  t <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) pi 0<span class="symbol">.</span>0
  a <span class="symbol">=</span> select (y <span class="symbol">==</span> 0<span class="symbol">.</span>0) t a
  t <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) (3<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">/</span> 4<span class="symbol">.</span>0) (pi <span class="symbol">/</span> 4<span class="symbol">.</span>0)
  a <span class="symbol">=</span> select (isinf x <span class="symbol">&amp;&amp;</span> isinf y) t a  <span class="comment">-- Handle infinite inputs.
</span>  a <span class="symbol">=</span> copysign a y
  select (either_is_nan x y) nan a  <span class="comment">-- Propagate NaNs.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> atan2 x 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Complex numbers</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> <span class="type-name">Float</span> <span class="type-name">Float</span>  <span class="comment">-- real, imaginary
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> allCloseComplex <span class="symbol">:</span> <span class="type-name">HasAllClose</span> <span class="type-name">Complex</span> <span class="keyword">where</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol (<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> (a <span class="symbol">~~</span> c) <span class="symbol">&amp;&amp;</span> (b <span class="symbol">~~</span> d)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> defaultToleranceComplex <span class="symbol">:</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Complex</span> <span class="keyword">where</span>
  atol <span class="symbol">=</span> <span class="type-name">MkComplex</span> atol atol
  rtol <span class="symbol">=</span> <span class="type-name">MkComplex</span> rtol rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> <span class="type-name">ComplexEq</span> <span class="symbol">:</span> <span class="type-name">Eq</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  <span class="type-name">MkEq</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> (a <span class="symbol">==</span> c) <span class="symbol">&amp;&amp;</span> (b <span class="symbol">==</span> d)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">ComplexAdd</span> <span class="symbol">:</span> <span class="type-name">Add</span> <span class="type-name">Complex</span> <span class="keyword">where</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> <span class="type-name">MkComplex</span> (a <span class="symbol">+</span> c) (b <span class="symbol">+</span> d)
  sub <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> <span class="type-name">MkComplex</span> (a <span class="symbol">-</span> c) (b <span class="symbol">-</span> d)
  zero <span class="symbol">=</span> <span class="type-name">MkComplex</span> 0<span class="symbol">.</span>0 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">ComplexMul</span> <span class="symbol">:</span> <span class="type-name">Mul</span> <span class="type-name">Complex</span> <span class="keyword">where</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span>
    <span class="type-name">MkComplex</span> (a <span class="symbol">*</span> c <span class="symbol">-</span> b <span class="symbol">*</span> d) (a <span class="symbol">*</span> d <span class="symbol">+</span> b <span class="symbol">*</span> c)
  one <span class="symbol">=</span> <span class="type-name">MkComplex</span> 1<span class="symbol">.</span>0 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span> complexVS <span class="symbol">:</span> <span class="type-name">VSpace</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  <span class="type-name">MkVSpace</span> <span class="type-name">ComplexAdd</span> <span class="symbol">\</span>a<span class="symbol">:</span><span class="type-name">Float</span> (<span class="type-name">MkComplex</span> c d)<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> <span class="type-name">MkComplex</span> (a <span class="symbol">*</span> c) (a <span class="symbol">*</span> d)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: Hook up to (/) operator.  Might require two-parameter VSpace.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_division (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) (<span class="type-name">MkComplex</span> c d<span class="symbol">:</span><span class="type-name">Complex</span>)<span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  <span class="type-name">MkComplex</span> ((a <span class="symbol">*</span> c <span class="symbol">+</span> b <span class="symbol">*</span> d) <span class="symbol">/</span> (c <span class="symbol">*</span> c <span class="symbol">+</span> d <span class="symbol">*</span> d)) ((b <span class="symbol">*</span> c <span class="symbol">-</span> a <span class="symbol">*</span> d) <span class="symbol">/</span> (c <span class="symbol">*</span> c <span class="symbol">+</span> d <span class="symbol">*</span> d))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_exp (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  expx <span class="symbol">=</span> exp a
  <span class="type-name">MkComplex</span> (expx <span class="symbol">*</span> cos b) (expx <span class="symbol">*</span> sin b)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_exp2 (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  exp2x <span class="symbol">=</span> exp2 a
  b&#39; <span class="symbol">=</span> b <span class="symbol">*</span> log 2<span class="symbol">.</span>0
  <span class="type-name">MkComplex</span> (exp2x <span class="symbol">*</span> cos b&#39;) (exp2x <span class="symbol">*</span> sin b&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_conj (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> a (<span class="symbol">-</span>b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_abs  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> a <span class="symbol">*</span> a <span class="symbol">+</span> b <span class="symbol">*</span> b
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_mag  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> sqrt (a <span class="symbol">*</span> a <span class="symbol">+</span> b <span class="symbol">*</span> b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_arg  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> atan2 b a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">complex_log   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> <span class="type-name">MkComplex</span> (log (complex_mag x)) (complex_arg x)
</div></div><div class="cell"><div class="code-block">complex_log2  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> (complex_log x) <span class="symbol">/</span> log 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">complex_log10 <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> (complex_log x) <span class="symbol">/</span> log 10<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">complex_pow <span class="symbol">=</span> <span class="symbol">\</span>base<span class="symbol">:</span><span class="type-name">Complex</span> power<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> complex_exp (power <span class="symbol">*</span> complex_log base)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_sqrt (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> complex_mag <span class="symbol">$</span> <span class="type-name">MkComplex</span> a b
  <span class="type-name">MkComplex</span> (sqrt ((a <span class="symbol">+</span> m) <span class="symbol">/</span> 2<span class="symbol">.</span>0)) (sign b <span class="symbol">*</span> sqrt ((m <span class="symbol">-</span> a) <span class="symbol">/</span> 2<span class="symbol">.</span>0))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_sin  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (sin  a <span class="symbol">*</span> cosh b) (cos   a <span class="symbol">*</span> sinh b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_sinh (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (sinh a <span class="symbol">*</span>  cos b) (cosh  a <span class="symbol">*</span> sin  b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_cos  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (cos  a <span class="symbol">*</span> cosh b) (<span class="symbol">-</span>sin  a <span class="symbol">*</span> sinh b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_cosh (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (cosh a <span class="symbol">*</span>  cos b) (<span class="symbol">-</span>sinh a <span class="symbol">*</span> sin  b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_tan  (x<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> complex_division (complex_sin  x) (complex_cos  x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_tanh (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  num <span class="symbol">=</span> <span class="type-name">MkComplex</span> (sinh a <span class="symbol">*</span> cos b) (cosh a <span class="symbol">*</span> sin  b)
  den <span class="symbol">=</span> <span class="type-name">MkComplex</span> (cosh a <span class="symbol">*</span> cos b) (sinh a <span class="symbol">*</span> sin  b)
  complex_division num den
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">ComplexFractional</span> <span class="symbol">:</span> <span class="type-name">Fractional</span> <span class="type-name">Complex</span> <span class="keyword">where</span>
  divide <span class="symbol">=</span> complex_division
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_floor (<span class="type-name">MkComplex</span> re im<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  <span class="comment">-- from &quot;Complex Floor&quot; by Eugene McDonnell
</span>  <span class="comment">-- https://www.jsoftware.com/papers/eem/complexfloor.htm
</span>  fr <span class="symbol">=</span> floor re
  fi <span class="symbol">=</span> floor im
  x <span class="symbol">=</span> re <span class="symbol">-</span> fr
  y <span class="symbol">=</span> im <span class="symbol">-</span> fi
  <span class="keyword">case</span> (x <span class="symbol">+</span> y) <span class="symbol">&lt;</span> 1<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">MkComplex</span> fr fi
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> x <span class="symbol">&gt;=</span> y <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">MkComplex</span> (fr <span class="symbol">+</span> 1<span class="symbol">.</span>0) fi
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">MkComplex</span> fr (fi <span class="symbol">+</span> 1<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">complex_ceil <span class="symbol">=</span>  <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> <span class="symbol">-</span>(complex_floor (<span class="symbol">-</span>x))
</div></div><div class="cell"><div class="code-block">complex_round <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> complex_floor <span class="symbol">$</span> <span class="type-name">MkComplex</span> 0<span class="symbol">.</span>5 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">complex_lgamma <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">-&gt;</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span>
  todo  <span class="comment">-- This one is pretty hairy.
</span></div></div><div class="cell"><div class="code-block">        <span class="comment">-- See https://cs.uwaterloo.ca/research/tr/1994/23/CS-94-23.pdf
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_log1p (x<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  (<span class="type-name">MkComplex</span> a b) <span class="symbol">=</span> x
  <span class="keyword">case</span> a <span class="symbol">==</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> x
    <span class="type-name">False</span> <span class="symbol">-&gt;</span>
      u <span class="symbol">=</span> x <span class="symbol">+</span> <span class="type-name">MkComplex</span> 1<span class="symbol">.</span>0 0<span class="symbol">.</span>0
      <span class="keyword">case</span> a <span class="symbol">&lt;=</span> <span class="symbol">-</span>1<span class="symbol">.</span>0 <span class="keyword">of</span>
        <span class="type-name">True</span> <span class="symbol">-&gt;</span> complex_log u
        <span class="type-name">False</span> <span class="symbol">-&gt;</span> divide ((complex_log u) <span class="symbol">*</span> x) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> complexFloating <span class="symbol">:</span> <span class="type-name">Floating</span> <span class="type-name">Complex</span> <span class="keyword">where</span>
  exp    <span class="symbol">=</span> complex_exp
  exp2   <span class="symbol">=</span> complex_exp2
  log    <span class="symbol">=</span> complex_log
  log2   <span class="symbol">=</span> complex_log2
  log10  <span class="symbol">=</span> complex_log10
  log1p  <span class="symbol">=</span> complex_log1p
  sin    <span class="symbol">=</span> complex_sin
  cos    <span class="symbol">=</span> complex_cos
  tan    <span class="symbol">=</span> complex_tan
  sinh   <span class="symbol">=</span> complex_sinh
  cosh   <span class="symbol">=</span> complex_cosh
  tanh   <span class="symbol">=</span> complex_tanh
  floor  <span class="symbol">=</span> complex_floor
  ceil   <span class="symbol">=</span> complex_ceil
  round  <span class="symbol">=</span> complex_round
  sqrt   <span class="symbol">=</span> complex_sqrt
  pow    <span class="symbol">=</span> complex_pow
  lgamma <span class="symbol">=</span> complex_lgamma
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Bitwise operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: type class like Haskell&#39;s `Bits`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&lt;</span>) (x<span class="symbol">:</span><span class="type-name">Byte</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Byte</span> <span class="symbol">=</span> %shl x (<span class="type-name">IToW8</span> y)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;&gt;</span>) (x<span class="symbol">:</span><span class="type-name">Byte</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Byte</span> <span class="symbol">=</span> %shr x (<span class="type-name">IToW8</span> y)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">.|.</span>) (x<span class="symbol">:</span><span class="type-name">Byte</span>) (y<span class="symbol">:</span><span class="type-name">Byte</span>) <span class="symbol">:</span> <span class="type-name">Byte</span> <span class="symbol">=</span> %or x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">.&amp;.</span>) (x<span class="symbol">:</span><span class="type-name">Byte</span>) (y<span class="symbol">:</span><span class="type-name">Byte</span>) <span class="symbol">:</span> <span class="type-name">Byte</span> <span class="symbol">=</span> %and x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Raw pointer operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Ptr</span> (ty<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %makePtrType ty
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tabToPtr (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">?-&gt;</span> (xs<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  %getPtr xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ptrToTab (n<span class="symbol">:</span><span class="type-name">Int</span>) (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> <span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span> %ptrLoad (%ptrOffset ptr (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Misc</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: could make an `unsafeCastIndex` and this could avoid the runtime copy
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: safe (runtime-checked) and unsafe versions
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> castTable (m<span class="symbol">:</span><span class="type-name">Type</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">case</span> size m <span class="symbol">==</span> size n <span class="keyword">of</span>
     <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>(unsafeFromOrdinal _ (ordinal i))
     <span class="type-name">False</span> <span class="symbol">-&gt;</span> throw
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> toList (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="type-name">AsList</span> _ <span class="symbol">$</span> castTable (<span class="type-name">Fin</span> n&#39;) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tail (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  numElts <span class="symbol">=</span> size n <span class="symbol">-</span> start
  toList <span class="symbol">$</span> slice xs start (<span class="type-name">Fin</span> numElts)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> padTo (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (m<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> (m<span class="symbol">=&gt;</span>a) <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="keyword">for</span> i<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> n&#39; <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs<span class="symbol">.</span>(i&#39;<span class="symbol">@</span>_)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> idivCeil (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> idiv x y <span class="symbol">+</span> <span class="type-name">BToI</span> (rem x y <span class="symbol">/=</span> 0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fromJust (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> a <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span> <span class="type-name">Just</span> x&#39; <span class="symbol">-&gt;</span> x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> anySat (f<span class="command">:a</span> <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> any (map f xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- In Haskell this would just be `mapM`. The equivalent for us would be having
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- an exception effect.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> seqMaybes (xs <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Maybe</span> (n <span class="symbol">=&gt;</span> a) <span class="symbol">=</span>
  <span class="comment">-- is it possible to implement this safely? (i.e. without using partial
</span>  <span class="comment">-- functions)
</span>  <span class="keyword">case</span> anySat isNothing xs <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> map fromJust xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linearSearch (_<span class="symbol">:</span><span class="type-name">Eq</span> a) <span class="symbol">?=&gt;</span> (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (query<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> n <span class="symbol">=</span>
  snd <span class="symbol">$</span> withState <span class="type-name">Nothing</span> <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    <span class="keyword">case</span> xs<span class="symbol">.</span>i <span class="symbol">==</span> query <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> ref <span class="symbol">:=</span> <span class="type-name">Just</span> i
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> listLength ((<span class="type-name">AsList</span> n _)<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- This is for efficiency (rather than using `&lt;&gt;` repeatedly)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want this for any monoid but this implementation won&#39;t work.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> concat (lists<span class="command">:n</span><span class="symbol">=&gt;</span>(<span class="type-name">List</span> a)) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  totalSize <span class="symbol">=</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> listLength lists<span class="symbol">.</span>i
  <span class="type-name">AsList</span> _ <span class="symbol">$</span> fst <span class="symbol">$</span> withState 0 <span class="symbol">\</span>listIdx<span class="symbol">.</span>
    fst <span class="symbol">$</span> withState 0 <span class="symbol">\</span>eltIdx<span class="symbol">.</span>
      <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> totalSize)<span class="symbol">.</span>
        while (<span class="symbol">\</span>()<span class="symbol">.</span> get eltIdx <span class="symbol">&gt;=</span> listLength (lists<span class="symbol">.</span>((get listIdx)<span class="symbol">@</span>_))) <span class="symbol">\</span>()<span class="symbol">.</span>
          eltIdx <span class="symbol">:=</span> 0
          listIdx <span class="symbol">:=</span> get listIdx <span class="symbol">+</span> 1
        (<span class="type-name">AsList</span> _ xs) <span class="symbol">=</span> lists<span class="symbol">.</span>((get listIdx)<span class="symbol">@</span>_)
        eltIdxVal <span class="symbol">=</span> get eltIdx
        eltIdx <span class="symbol">:=</span> eltIdxVal <span class="symbol">+</span> 1
        xs<span class="symbol">.</span>(eltIdxVal<span class="symbol">@</span>_)
</div></div></div></body></html>