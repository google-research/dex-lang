<!DOCTYPE HTML>
<html><head><style type="text/css">/*Copyright2019GoogleLLC*//**//*UseofthissourcecodeisgovernedbyaBSD-style*//*licensethatcanbefoundintheLICENSEfileorat*//*https://developers.google.com/open-source/licenses/bsd*/body{margin:1emauto1emauto;padding:1em1em1em1em;max-width:50em;font-family:Helvetica,sans-serif;font-size:100%;color:#333;padding-bottom:500px;}.cell{}.code-block,.err-block,.result-block{padding:0em0em0em2em;display:block;font-family:monospace;white-space:pre;}code{background-color:#F0F0F0;}.result-block{border-left:3pxsolid#87CEFA;}.prose-block{line-height:140%;}.err-block{font-weight:bold;color:#B22222;border-left:3pxsolid#B22222;}.plot{padding:5em;}.plot-img{width:80%;}.comment{color:#808080;}.keyword{color:#0000DD;}.command{color:#A80000;}.symbol{color:#E07000;}.type-name{color:#A80000;}.iso-sugar{color:#25BBA7;}</style><meta charset="UTF-8"></head><body><div id="main-output"><div class="cell"><div class="prose-block"><h1>Rejection sampler of a Binomial distribution</h1>
</div></div><div class="cell"><div class="prose-block"><p>We implement rejection sampling from a Binomial distribution using a uniform proposal.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rejectionSample (try<span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> <span class="type-name">Maybe</span> a) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  iter <span class="symbol">\</span>i<span class="symbol">.</span> <span class="keyword">case</span> try <span class="symbol">$</span> hash k i <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Continue</span>
    <span class="type-name">Just</span> x  <span class="symbol">-&gt;</span> <span class="type-name">Done</span> x
</div><div class="err-block">Type error:
Expected: (a -&gt; IterResult a b)
  Actual: (IterResult c a)
(Solving for: [a:Type, b:Type, c:Type])

    Just x  -&gt; Done x
               ^^^^^^
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Prob</span>    <span class="symbol">=</span> <span class="type-name">Float</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">LogProb</span> <span class="symbol">=</span> <span class="type-name">Float</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- log probability density of a Binomial distribution
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logBinomialProb (n<span class="symbol">:</span><span class="type-name">Int</span>) (p<span class="symbol">:</span><span class="type-name">Prob</span>) (counts<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">LogProb</span> <span class="symbol">=</span>
  pSuccess <span class="symbol">=</span> log p <span class="symbol">*</span> <span class="type-name">IToF</span> counts
  pFailure <span class="symbol">=</span> log1p (<span class="symbol">-</span>p) <span class="symbol">*</span> <span class="type-name">IToF</span> (n <span class="symbol">-</span> counts)
  normConst <span class="symbol">=</span> (lbeta (1<span class="symbol">.</span> <span class="symbol">+</span> <span class="type-name">IToF</span> counts) (1<span class="symbol">.</span> <span class="symbol">+</span> <span class="type-name">IToF</span> n <span class="symbol">-</span> <span class="type-name">IToF</span> counts) <span class="symbol">+</span>
               log1p (<span class="type-name">IToF</span> n))
  pSuccess <span class="symbol">+</span> pFailure <span class="symbol">-</span> normConst
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> trySampleBinomial (n<span class="symbol">:</span><span class="type-name">Int</span>) (p<span class="symbol">:</span><span class="type-name">Prob</span>) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> <span class="type-name">Int</span> <span class="symbol">=</span>
  [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> splitKey k
  proposal <span class="symbol">=</span> <span class="type-name">FToI</span> <span class="symbol">$</span> floor <span class="symbol">$</span> rand k1 <span class="symbol">*</span> <span class="type-name">IToF</span> (n <span class="symbol">+</span> 1)
  <span class="keyword">if</span> proposal <span class="symbol">&gt;</span> n
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span>
      acceptance <span class="symbol">=</span> log (rand k2) <span class="symbol">&lt;</span> logBinomialProb n p proposal
      <span class="keyword">if</span> acceptance
        <span class="keyword">then</span> <span class="type-name">Just</span> proposal
        <span class="keyword">else</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Example</h2>
</div></div><div class="cell"><div class="prose-block"><p>We test the implementation by sampling from a Binomial distribution with 10 trials and success probability 0.4.</p>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- parameters
</span></div></div><div class="cell"><div class="code-block">n <span class="symbol">=</span> 10
</div></div><div class="cell"><div class="code-block">p <span class="symbol">=</span> 0<span class="symbol">.</span>4
</div></div><div class="cell"><div class="code-block">numSamples <span class="symbol">=</span> 5000
</div></div><div class="cell"><div class="code-block">k0 <span class="symbol">=</span> newKey 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">rejectionSamples <span class="symbol">=</span> randVec numSamples (rejectionSample <span class="symbol">$</span> trySampleBinomial n p) k0
</div><div class="err-block">Error: variable not in scope: rejectionSample

rejectionSamples = randVec numSamples (rejectionSample $ trySampleBinomial n p) k0
                                       ^^^^^^^^^^^^^^^^
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> slice rejectionSamples 0 <span class="symbol">$</span> <span class="type-name">Fin</span> 10
</div><div class="err-block">Error: variable not in scope: rejectionSamples

:p slice rejectionSamples 0 $ Fin 10
         ^^^^^^^^^^^^^^^^^
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>The Binomial distribution has mean 4 and variance 2.4.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> meanAndVariance (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> (<span class="type-name">Float</span><span class="symbol">&amp;</span><span class="type-name">Float</span>) <span class="symbol">=</span> (mean xs<span class="symbol">,</span> sq <span class="symbol">$</span> std xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> meanAndVariance <span class="symbol">$</span> map <span class="type-name">IToF</span> rejectionSamples
</div><div class="err-block">Error: variable not in scope: rejectionSamples

:p meanAndVariance $ map IToF rejectionSamples
                              ^^^^^^^^^^^^^^^^
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Alternative: Inversion sampling</h2>
</div></div><div class="cell"><div class="prose-block"><p>Alternatively, we can use inversion sampling.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> binomialSample (n<span class="symbol">:</span><span class="type-name">Int</span>) (p<span class="symbol">:</span><span class="type-name">Prob</span>) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> n <span class="symbol">+</span> 1
  logprobs <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> m)<span class="symbol">.</span> logBinomialProb n p <span class="symbol">$</span> ordinal i
  ordinal <span class="symbol">$</span> categorical logprobs k
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">inversionSamples <span class="symbol">=</span> randVec numSamples (binomialSample n p) k0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> slice inversionSamples 0 <span class="symbol">$</span> <span class="type-name">Fin</span> 10
</div><div class="result-block">[6, 7, 6, 5, 3, 2, 4, 4, 3, 4]</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> meanAndVariance <span class="symbol">$</span> map <span class="type-name">IToF</span> inversionSamples
</div><div class="result-block">(3.9977999, 2.4097958)</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>The following variant is guaranteed to evaluate the CDF only once.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> binomialBatch (n<span class="symbol">:</span><span class="type-name">Int</span>) (p<span class="symbol">:</span><span class="type-name">Prob</span>) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> a <span class="symbol">=&gt;</span> <span class="type-name">Int</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> n <span class="symbol">+</span> 1
  logprobs <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> m)<span class="symbol">.</span> logBinomialProb n p <span class="symbol">$</span> ordinal i
  map ordinal <span class="symbol">$</span> categoricalBatch logprobs k
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">inversionBatchSamples <span class="symbol">=</span> (binomialBatch n p k0) <span class="symbol">:</span> <span class="type-name">Fin</span> numSamples <span class="symbol">=&gt;</span> <span class="type-name">Int</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> slice inversionBatchSamples 0 <span class="symbol">$</span> <span class="type-name">Fin</span> 10
</div><div class="result-block">[6, 7, 6, 5, 3, 2, 4, 4, 3, 4]</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> meanAndVariance <span class="symbol">$</span> map <span class="type-name">IToF</span> inversionBatchSamples
</div><div class="result-block">(3.9977999, 2.4097958)</div></div></div></body></html>