<!DOCTYPE HTML>
<html><head><style type="text/css">/*Copyright2019GoogleLLC*//**//*UseofthissourcecodeisgovernedbyaBSD-style*//*licensethatcanbefoundintheLICENSEfileorat*//*https://developers.google.com/open-source/licenses/bsd*/body{margin:1emauto1emauto;padding:1em1em1em1em;max-width:50em;font-family:Helvetica,sans-serif;font-size:100%;color:#333;padding-bottom:500px;}.cell{}.code-block,.err-block,.result-block{padding:0em0em0em2em;display:block;font-family:monospace;white-space:pre;}code{background-color:#F0F0F0;}.result-block{border-left:3pxsolid#87CEFA;}.prose-block{line-height:140%;}.err-block{font-weight:bold;color:#B22222;border-left:3pxsolid#B22222;}.plot{padding:5em;}.plot-img{width:80%;}.comment{color:#808080;}.keyword{color:#0000DD;}.command{color:#A80000;}.symbol{color:#E07000;}.type-name{color:#A80000;}.iso-sugar{color:#25BBA7;}</style><meta charset="UTF-8"></head><body><div id="main-output"><div class="cell"><div class="prose-block"><h1>Particle Swarm Optimizer</h1>
</div></div><div class="cell"><div class="prose-block"><h2>Fitness function</h2>
</div></div><div class="cell"><div class="code-block">rosenbrock <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="symbol">\</span>x y<span class="symbol">.</span> sq (1<span class="symbol">.</span>0 <span class="symbol">-</span> x) <span class="symbol">+</span> 80<span class="symbol">.</span>0<span class="symbol">*</span>sq (y <span class="symbol">-</span> x<span class="symbol">*</span>x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>We write one that uses vector for input</p>
</div></div><div class="cell"><div class="code-block">rosenbrock2 <span class="symbol">:</span> ((<span class="type-name">Fin</span> 2)<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="symbol">\</span>xs<span class="symbol">.</span>
    x <span class="symbol">=</span> xs<span class="symbol">.</span>(fromOrdinal _ 0)
    y <span class="symbol">=</span> xs<span class="symbol">.</span>(fromOrdinal _ 1)
    rosenbrock x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Min should be at 1.0, 1.0</p>
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> rosenbrock 1<span class="symbol">.</span>0 1<span class="symbol">.</span>000
</div><div class="result-block">0.0</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> rosenbrock2 [1<span class="symbol">.</span>0<span class="symbol">,</span> 1<span class="symbol">.</span>000]
</div><div class="result-block">0.0</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> rosenbrock 1<span class="symbol">.</span>0 1<span class="symbol">.</span>02
</div><div class="result-block">3.199994e-2</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> rosenbrock2 [1<span class="symbol">.</span>0<span class="symbol">,</span> 1<span class="symbol">.</span>02]
</div><div class="result-block">3.199994e-2</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Helper functions</h2>
</div></div><div class="cell"><div class="code-block">minbyfst <span class="symbol">:</span> (<span class="type-name">Float</span> <span class="symbol">&amp;</span> a) <span class="symbol">-&gt;</span> (<span class="type-name">Float</span> <span class="symbol">&amp;</span> a) <span class="symbol">-&gt;</span> (<span class="type-name">Float</span> <span class="symbol">&amp;</span> a) <span class="symbol">=</span> minBy fst
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">minimumbyfst <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>(<span class="type-name">Float</span> <span class="symbol">&amp;</span> a)) <span class="symbol">-&gt;</span> (<span class="type-name">Float</span> <span class="symbol">&amp;</span> a) <span class="symbol">=</span> minimumBy fst
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Rand helpers</h3>
</div></div><div class="cell"><div class="prose-block"><p>make a random vector uniformly distributed between <code>lb</code> and <code>ub</code></p>
</div></div><div class="cell"><div class="code-block">randBounded <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> (d<span class="symbol">=&gt;</span><span class="type-name">Float</span>)<span class="symbol">-&gt;</span>(d<span class="symbol">=&gt;</span><span class="type-name">Float</span>)<span class="symbol">-&gt;</span>(d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span>
  <span class="symbol">\</span>key lb ub<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span> lb<span class="symbol">.</span>i <span class="symbol">+</span> ((rand <span class="symbol">$</span> ixkey key i) <span class="symbol">*</span> (ub<span class="symbol">.</span>i <span class="symbol">-</span> lb<span class="symbol">.</span>i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> randBounded (newKey 4) [1<span class="symbol">.</span>0<span class="symbol">,</span>  <span class="symbol">-</span>2<span class="symbol">.</span>0] [<span class="symbol">-</span>1<span class="symbol">.</span>0<span class="symbol">,</span>  2<span class="symbol">.</span>0]
</div><div class="result-block">[-0.35101044, 1.4935503]</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>The Optimizer itself.</h2>
<p>We have <strong>arguments</strong>:</p>
<ul>
<li>type explicit, <code>np:Ix</code>: number of particles</li>
<li>type explicit, <code>niter:Ix</code>: number of iterations</li>
<li>type: <code>d:Ix</code>: number of dimensions in the domain of <code>f</code>, i.e. the search space.</li>
<li><code>f:(d=&gt;Float)-&gt;Float</code>: loss function being minimized.</li>
<li><code>(lb,ub):(d=&gt;Float,d=&gt;Float)</code>: boundries of the space being searched</li>
<li><code>(momentum,gRate,pRate):(Float,Float,Float)</code>: PSO hyper-parameters to control exploration vs exploitation.</li>
</ul>
</div></div><div class="cell"><div class="prose-block"><p><strong>Returns</strong>: the optimal point found with-in the bounds on the input domain of <code>f</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> optimize
      (d<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span>
      (np&#39;<span class="symbol">:</span><span class="type-name">Int</span>)                                        <span class="comment">-- number of particles
</span>      (niter<span class="symbol">:</span><span class="type-name">Int</span>)                                      <span class="comment">-- number of iterations
</span>      (key<span class="symbol">:</span><span class="type-name">Key</span>)                                        <span class="comment">-- random seed
</span>      (f<span class="symbol">:</span>(d<span class="symbol">=&gt;</span><span class="type-name">Float</span>)<span class="symbol">-&gt;</span><span class="type-name">Float</span>)                              <span class="comment">-- function to optimize
</span>      ((lb<span class="symbol">,</span>ub)<span class="symbol">:</span>(d<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">&amp;</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>))                    <span class="comment">-- bounds
</span>      ((momentum<span class="symbol">,</span> gRate<span class="symbol">,</span> pRate)<span class="symbol">:</span>(<span class="type-name">Float</span> <span class="symbol">&amp;</span> <span class="type-name">Float</span> <span class="symbol">&amp;</span> <span class="type-name">Float</span>))  <span class="comment">-- momentum/pRate/gRate
</span>      <span class="symbol">:</span> (d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span>
    np <span class="symbol">=</span> <span class="type-name">Fin</span> np&#39;
    optStep <span class="symbol">=</span> <span class="symbol">\</span>(keyL<span class="symbol">,</span> gbest<span class="symbol">,</span> pbests<span class="symbol">,</span> positions<span class="symbol">,</span> velocities)<span class="symbol">.</span>
        newPositions<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> positions <span class="symbol">+</span> velocities
        newPbests<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>(<span class="type-name">Float</span> <span class="symbol">&amp;</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>)) <span class="symbol">=</span> <span class="keyword">for</span> p<span class="symbol">.</span>
            minbyfst pbests<span class="symbol">.</span>p (f newPositions<span class="symbol">.</span>p<span class="symbol">,</span> newPositions<span class="symbol">.</span>p)
        newGbest<span class="symbol">:</span>(<span class="type-name">Float</span> <span class="symbol">&amp;</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span>
            minbyfst gbest (minimumbyfst newPbests)
        [keyG<span class="symbol">,</span> keyP<span class="symbol">,</span> keyNext] <span class="symbol">=</span> splitKey keyL
        (gscore<span class="symbol">,</span> gloc) <span class="symbol">=</span> gbest
        plocs <span class="symbol">=</span> map snd pbests
        gVel<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> <span class="keyword">for</span> p i<span class="symbol">.</span>
            weight <span class="symbol">=</span> rand <span class="symbol">$</span> (ixkey2 keyG p i)
            dir <span class="symbol">=</span> gloc<span class="symbol">.</span>i <span class="symbol">-</span> positions<span class="symbol">.</span>p<span class="symbol">.</span>i
            weight <span class="symbol">*</span> dir
        pVel<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> <span class="keyword">for</span> p i<span class="symbol">.</span>
            weight <span class="symbol">=</span> rand <span class="symbol">$</span> (ixkey2 keyP p i)
            dir <span class="symbol">=</span> plocs<span class="symbol">.</span>p<span class="symbol">.</span>i <span class="symbol">-</span> positions<span class="symbol">.</span>p<span class="symbol">.</span>i
            weight <span class="symbol">*</span> dir
        newVelocities<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> momentum <span class="symbol">.*</span> velocities <span class="symbol">+</span> gRate <span class="symbol">.*</span> gVel <span class="symbol">+</span> pRate <span class="symbol">.*</span> gVel
        (keyNext<span class="symbol">,</span>newGbest<span class="symbol">,</span>newPbests<span class="symbol">,</span>newPositions<span class="symbol">,</span>newVelocities)
    randInit1 <span class="symbol">=</span> <span class="symbol">\</span>keyI1<span class="symbol">.</span> randBounded keyI1 lb ub
    randInit  <span class="symbol">=</span> <span class="symbol">\</span>keyI<span class="symbol">.</span> <span class="keyword">for</span> p<span class="command">:np</span><span class="symbol">.</span> randInit1 <span class="symbol">$</span> ixkey keyI p
    [keyPos<span class="symbol">,</span> keyVel<span class="symbol">,</span> keyLoop] <span class="symbol">=</span> splitKey key
    initPositions<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> randInit keyPos
    initVelocities<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> randInit keyVel
    initPs<span class="symbol">:</span>(np<span class="symbol">=&gt;</span>(<span class="type-name">Float</span> <span class="symbol">&amp;</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>)) <span class="symbol">=</span> <span class="keyword">for</span> p<span class="symbol">.</span> (f initPositions<span class="symbol">.</span>p<span class="symbol">,</span> initPositions<span class="symbol">.</span>p)
    initG<span class="symbol">:</span>(<span class="type-name">Float</span> <span class="symbol">&amp;</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> minimumbyfst initPs
    inits <span class="symbol">=</span> (keyLoop<span class="symbol">,</span>initG<span class="symbol">,</span>initPs<span class="symbol">,</span>initPositions<span class="symbol">,</span>initVelocities)
    res <span class="symbol">=</span> fold inits (<span class="symbol">\</span>iter<span class="symbol">:</span>(<span class="type-name">Fin</span> niter)<span class="symbol">.</span> optStep)
    (dc0<span class="symbol">,</span>(finalGscore<span class="symbol">,</span> finalGloc)<span class="symbol">,</span>dc1<span class="symbol">,</span>dc2<span class="symbol">,</span>dc3) <span class="symbol">=</span> res
    finalGloc
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><hr />
<p>Lets see how it goes.
Run it for more iterations and result should improve.
Which it indeed does.</p>
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> optimize 50 10 (newKey 0) rosenbrock2 ([<span class="symbol">-</span>10<span class="symbol">.</span>0<span class="symbol">,</span> <span class="symbol">-</span>10<span class="symbol">.</span>0]<span class="symbol">,</span>[20<span class="symbol">.</span>0<span class="symbol">,</span> 20<span class="symbol">.</span>0]) (0<span class="symbol">.</span>5<span class="symbol">,</span>0<span class="symbol">.</span>3<span class="symbol">,</span>0<span class="symbol">.</span>4)
</div><div class="result-block">[7.698673e-2, 0.23281813]</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> optimize 50 20 (newKey 0) rosenbrock2 ([<span class="symbol">-</span>10<span class="symbol">.</span>0<span class="symbol">,</span> <span class="symbol">-</span>10<span class="symbol">.</span>0]<span class="symbol">,</span>[20<span class="symbol">.</span>0<span class="symbol">,</span> 20<span class="symbol">.</span>0]) (0<span class="symbol">.</span>5<span class="symbol">,</span>0<span class="symbol">.</span>3<span class="symbol">,</span>0<span class="symbol">.</span>4)
</div><div class="result-block">[0.90125203, 0.750448]</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> optimize 50 100 (newKey 0) rosenbrock2 ([<span class="symbol">-</span>10<span class="symbol">.</span>0<span class="symbol">,</span> <span class="symbol">-</span>10<span class="symbol">.</span>0]<span class="symbol">,</span>[20<span class="symbol">.</span>0<span class="symbol">,</span> 20<span class="symbol">.</span>0]) (0<span class="symbol">.</span>5<span class="symbol">,</span>0<span class="symbol">.</span>3<span class="symbol">,</span>0<span class="symbol">.</span>4)
</div><div class="result-block">[0.99907273, 0.99819493]</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="command">:p</span> optimize 50 1000 (newKey 0) rosenbrock2 ([<span class="symbol">-</span>10<span class="symbol">.</span>0<span class="symbol">,</span> <span class="symbol">-</span>10<span class="symbol">.</span>0]<span class="symbol">,</span>[20<span class="symbol">.</span>0<span class="symbol">,</span> 20<span class="symbol">.</span>0]) (0<span class="symbol">.</span>5<span class="symbol">,</span>0<span class="symbol">.</span>3<span class="symbol">,</span>0<span class="symbol">.</span>4)
</div><div class="result-block">[1.0, 1.0]</div></div></div></body></html>