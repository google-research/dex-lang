<!DOCTYPE HTML>
<html><head><meta charset="UTF-8"><style type="text/css">/* Copyright 2019 Google LLC                              */
/*                                                        */
/* Use of this source code is governed by a BSD-style     */
/* license that can be found in the LICENSE file or at    */
/* https://developers.google.com/open-source/licenses/bsd */

body {
  font-family: Helvetica, sans-serif;
  font-size: 100%;
  color: #333;
  display: flex;
  justify-content: space-between;
  overflow-x: hidden;

  --main-width: 50rem;
  --nav-width: 20rem;
}

@media (max-width: 70rem) {
    /*For narrow screens hide nav and enable horizontal scrolling */
    nav {display: none;}
    body {overflow-x: auto;}
}

nav {/* this actually just holds space for #navbar, which is fixed */
  min-width: var(--nav-width);
  max-width: var(--nav-width);
}
#navbar {
  position: fixed;
  height: 100vh;
  width: var(--nav-width);
  overflow-y: scroll;
  border-right: 1px solid firebrick;
}
#navbar:before {
  content: "Contents";
  font-weight: bold;
}
nav ol {
  list-style-type:none;
  padding-left: 1rem;
}

#main-output {
  max-width: var(--main-width);
  margin: auto;
}

.code-block, .err-block, .result-block {
  padding: 0em 0em 0em 2em;
  display: block;
  font-family: monospace;
  white-space: pre;
}

code {
  background-color: #F0F0F0;
}

.result-block {
  border-left: 3px solid  #87CEFA;
}

.prose-block {
  line-height: 140%;
}

.err-block {
  font-weight: bold;
  color: #B22222;
  border-left: 3px solid #B22222;
}

.plot {
  padding: 5em;
}

.plot-img {
  width: 80%;
}

.comment {
  color: #808080;
}

.keyword {
  color: #0000DD;
}

.command {
  color: #A80000;
}

.symbol {
  color: #E07000;
}

.type-name {
  color: #A80000;
}

.iso-sugar {
  color: #25BBA7;
}
</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" onload="// Copyright 2019 Google LLC
//
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file or at
// https://developers.google.com/open-source/licenses/bsd

var katexOptions = {
    delimiters: [
        {left: &quot;$$&quot;, right: &quot;$$&quot;, display: true},
        {left: &quot;\\[&quot;, right: &quot;\\]&quot;, display: true},
        {left: &quot;$&quot;, right: &quot;$&quot;, display: false},
        {left: &quot;\\(&quot;, right: &quot;\\)&quot;, display: false}
    ],
    // Enable commands that load resources or change HTML attributes
    // (e.g. hyperlinks): https://katex.org/docs/security.html.
    trust: true
};

var cells = {};

function append_contents(key, contents) {
    if (key in cells) {
        var cur_cells = cells[key];
    } else {
        var cell = document.createElement(&quot;div&quot;);
        cell.className = &quot;cell&quot;;
        cells[key] = [cell];
        var cur_cells = [cell];
    }
    for (var i = 0; i &lt; contents.length; i++) {
        for (var j = 0; j &lt; cur_cells.length; j++) {
            var node = lookup_address(cur_cells[j], contents[i][0])
            node.innerHTML += contents[i][1];
        }
    }
}

function lookup_address(cell, address) {
    var node = cell
    for (i = 0; i &lt; address.length; i++) {
        node = node.children[address[i]]
    }
    return node
}

function renderHovertips() {
    var spans = document.querySelectorAll(&quot;.code-span&quot;);
    Array.from(spans).map((span) =&gt; attachHovertip(span));
}

function attachHovertip(node) {
    node.addEventListener(&quot;mouseover&quot;, (event) =&gt; highlightNode(     event, node));
    node.addEventListener(&quot;mouseout&quot; , (event) =&gt; removeHighlighting(event, node));
}

function highlightNode(event, node) {
    event.stopPropagation();
    node.style.backgroundColor = &quot;lightblue&quot;;
    node.style.outlineColor = &quot;lightblue&quot;;
    node.style.outlineStyle = &quot;solid&quot;;
    Array.from(node.children).map(function (child) {
        if (isCodeSpanOrLeaf(child)) {
            child.style.backgroundColor = &quot;yellow&quot;;
        }
    })
}

function isCodeSpanOrLeaf(node) {
  return node.classList.contains(&quot;code-span&quot;) || node.classList.contains(&quot;code-span-leaf&quot;)

}

function removeHighlighting(event, node) {
    event.stopPropagation();
    node.style.backgroundColor = null;
    node.style.outlineColor = null;
    node.style.outlineStyle = null;
    Array.from(node.children).map(function (child) {
        if (isCodeSpanOrLeaf(child)) {
          child.style.backgroundColor = null;
        }
    })
}

function renderLaTeX() {
    // Render LaTeX equations in prose blocks via KaTeX, if available.
    // Skip rendering if KaTeX is unavailable.
    if (typeof renderMathInElement == &#39;undefined&#39;) {
        return;
    }
    // Render LaTeX equations in prose blocks via KaTeX.
    var proseBlocks = document.querySelectorAll(&quot;.prose-block&quot;);
    Array.from(proseBlocks).map((proseBlock) =&gt;
        renderMathInElement(proseBlock, katexOptions)
    );
}

/**
 * Rendering the Table of Contents / Navigation Bar
 * 2 key functions
 *  - `updateNavigation()` which inserts/updates the navigation bar
 *  - and it&#39;s helper `extractStructure()` which extracts the structure of the page
 *    and adds ids to heading elements.
*/
function updateNavigation() {
    function navItemList(struct) {
        var listEle = document.createElement(&#39;ol&#39;)
        struct.children.forEach(childStruct=&gt;
            listEle.appendChild(navItem(childStruct))
        );
        return listEle;
    }
    function navItem(struct) {
        var a = document.createElement(&#39;a&#39;);
        a.appendChild(document.createTextNode(struct.text));
        a.title = struct.text;
        a.href = &quot;#&quot;+struct.id;

        var ele = document.createElement(&#39;li&#39;)
        ele.appendChild(a)
        ele.appendChild(navItemList(struct));
        return ele;
    }

    var navbarEle = document.getElementById(&quot;navbar&quot;)
    if (navbarEle === null) {  // create it
        navbarEle = document.createElement(&quot;div&quot;);
        navbarEle.id=&quot;navbar&quot;;
        navOuterEle = document.createElement(&quot;nav&quot;)
        navOuterEle.appendChild(navbarEle);
        document.body.prepend(navOuterEle);
    }

    navbarEle.innerHTML = &quot;&quot;
    var structure = extractStructure()
    navbarEle.appendChild(navItemList(structure));
}

function extractStructure() { // Also sets ids on h1,h2,...
    var headingsNodes = document.querySelectorAll(&quot;h1, h2, h3, h4, h5, h6&quot;);
    // For now we are just fulling going to regenerate the structure each time
    // Might be better if we made minimal changes, but ðŸ¤·

    // Extract the structure of the document
    var structure = {children:[]}
    var active = [structure.children];
    headingsNodes.forEach(
        function(currentValue, currentIndex) {
            currentValue.id = &quot;s-&quot; + currentIndex;
            var currentLevel = parseInt(currentValue.nodeName[1]);

            // Insert dummy levels up for any levels that are skipped
            for (var i=active.length; i &lt; currentLevel; i++) {
                var dummy = {id: &quot;&quot;, text: &quot;&quot;, children: []}
                active.push(dummy.children);
                var parentList = active[i-1]
                parentList.push(dummy);
            }
            // delete this level and everything after
            active.splice(currentLevel, active.length);

            var currentStructure = {
                id: currentValue.id,
                text: currentValue.textContent,
                children: [],
            };
            active.push(currentStructure.children);

            var parentList = active[active.length-2]
            parentList.push(currentStructure);
        },
    );
    return structure;
}

/**
 * HTML rendering mode.
 * Static rendering is used for static HTML pages.
 * Dynamic rendering is used for dynamic HTML pages via `dex web`.
 *
 * @enum {string}
 */
var RENDER_MODE = Object.freeze({
  STATIC: &quot;static&quot;,
  DYNAMIC: &quot;dynamic&quot;,
})

/**
 * Renders the webpage.
 * @param {RENDER_MODE} renderMode The render mode, either static or dynamic.
 */
function render(renderMode) {
    if (renderMode == RENDER_MODE.STATIC) {
        // For static pages, simply call rendering functions once.
        renderLaTeX();
        renderHovertips();
        updateNavigation();
    } else {
        // For dynamic pages (via `dex web`), listen to update events.
        var source = new EventSource(&quot;/getnext&quot;);
        source.onmessage = function(event) {
            var body = document.getElementById(&quot;main-output&quot;);
            var msg = JSON.parse(event.data);
            if (msg == &quot;start&quot;) {
                body.innerHTML = &quot;&quot;;
                cells = {}
                return
            }
            var order    = msg[0];
            var contents = msg[1];
            for (var i = 0; i &lt; contents.length; i++) {
                append_contents(contents[i][0], contents[i][1]);
            }
            if (order != null) {
                var new_cells = {};
                body.innerHTML = &quot;&quot;;
                for (var i = 0; i &lt; order.val.length; i++) {
                    var key = order.val[i]
                    var cur_cells = cells[key]
                    if (cur_cells.length == 0) {
                        var cur_cell = new_cells[key][0].cloneNode(true)
                    } else {
                        var cur_cell = cur_cells.pop()
                        if (key in new_cells) {
                            new_cells[key].push(cur_cell);
                        } else {
                            new_cells[key] = [cur_cell];
                        }
                    }
                    body.appendChild(cur_cell);
                }
                Object.assign(cells, new_cells);
            }
            renderLaTeX();
            renderHovertips();
            updateNavigation();
        };
    }
}
render(RENDER_MODE.STATIC);"></script></head><body><div id="main-output"><div class="cell"><div class="code-block"></div></div><div class="cell"><div class="prose-block"><h1>BFGS optimizer</h1>
<p>The BFGS method is a quasi-Newton algorithm for solving unconstrained nonlinear
optimization problems. A BFGS iteration entails computing a line search
direction based on the gradient and Hessian approximation, finding a new point
in the line search direction that satisfies the Wolfe conditions, and updating
the Hessian approximation at the new point. This implementation is based on
BFGS as described in Nocedal, Jorge; Wright, Stephen J. (2006), Numerical
Optimization (2nd ed).</p>
</div></div><div class="cell"><div class="prose-block"><p>This example demonstrates Dex's ability to do fast, stateful loops with a
statically unknown number of iterations. See <code>benchmarks/bfgs.py</code> for a
comparison with Jaxopt BFGS on a multiclass logistic regression problem.</p>
</div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>outer_product(<span class="code-span"><span class="code-span-leaf">x</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">y</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span"><span class="code-span-leaf">m</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span"><span class="code-span-leaf">m</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span>)<span class="whitespace"> </span></span><span class="keyword">given</span><span class="whitespace"> </span>(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">m</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span>)<span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">i</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf">n</span></span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">j</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf">m</span></span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">x</span><span class="code-span">[<span class="code-span-leaf">i</span>]</span></span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">y</span><span class="code-span">[<span class="code-span-leaf">j</span>]</span></span></span></span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>zoom(<span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">f_line</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span-leaf"><span class="type-name">Float</span></span>)</span><span class="code-span-leaf"><span class="symbol">-&gt;</span></span></span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">a_lo_init</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">a_hi_init</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">c1</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">c2</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace">
</span></span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="comment">-- Zoom line search helper; Algorithm 3.6 from Nocedal and Wright (2006).</span><span class="whitespace">

  </span><span class="code-span"><span class="code-span-leaf">f0</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f_line</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">g0</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">grad</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f_line<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span></span></span></span><span class="whitespace">

  </span><span class="code-span"><span class="code-span-leaf">a_hi_ref</span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_hi_init</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">a_lo_ref</span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_lo_init</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">iter</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span><span class="symbol">\</span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">a_lo</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_lo_ref</span></span></span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">a_hi</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_hi_ref</span></span></span><span class="whitespace">

    </span><span class="symbol">--</span><span class="type-name">Find</span><span class="whitespace"> </span>a<span class="whitespace"> </span>trial<span class="whitespace"> </span>step<span class="whitespace"> </span>length<span class="whitespace"> </span>between<span class="whitespace"> </span>a_lo<span class="whitespace"> </span>and<span class="whitespace"> </span>a_hi<span class="symbol">.</span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">a_i</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">0<span class="symbol">.</span>5</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">a_lo</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_hi</span></span>)</span></span></span><span class="whitespace">

    </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span">(<span class="code-span"><span class="code-span-leaf">a_hi</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">-</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_lo</span></span>)<span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">&lt;</span></span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span>000001<span class="whitespace">  </span><span class="comment">-- The line search failed.</span></span></span><span class="whitespace">
      </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Done</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span><span class="whitespace">
      </span><span class="keyword">else</span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">f_ai</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f_line</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">f_ai</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">f0</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">c1</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_i</span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">g0</span></span></span>)<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">||</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f_ai</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;=</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f_line</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_lo</span></span></span></span><span class="whitespace">
          </span><span class="keyword">then</span><span class="whitespace">
            </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">a_hi_ref</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_i</span></span></span><span class="whitespace">
            </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Continue</span></span></span><span class="whitespace">
          </span><span class="keyword">else</span><span class="whitespace">
            </span><span class="code-span"><span class="code-span-leaf">g_i</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">grad</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f_line<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span></span><span class="whitespace">
            </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">abs</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>g_i<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">&lt;=</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span"><span class="symbol">-</span><span class="code-span-leaf">c2</span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">g0</span></span>)</span></span><span class="whitespace">
              </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Done</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span><span class="whitespace">
              </span><span class="keyword">else</span><span class="whitespace">
                </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">g_i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">a_hi</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">-</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_lo</span></span>)<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">&gt;=</span></span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span></span></span><span class="whitespace">
                  </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">a_hi_ref</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_lo</span></span></span></span><span class="whitespace">
                </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">a_lo_ref</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_i</span></span></span><span class="whitespace">
                </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Continue</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>zoom_line_search(<span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">maxiter</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Nat</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">f</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span-leaf"><span class="type-name">Float</span></span>)</span><span class="code-span-leaf"><span class="symbol">-&gt;</span></span></span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace">
  </span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="symbol">--</span><span class="type-name">Algorithm</span><span class="whitespace"> </span>3<span class="symbol">.</span>5<span class="whitespace"> </span>from<span class="whitespace"> </span><span class="type-name">Nocedal</span><span class="whitespace"> </span>and<span class="whitespace"> </span><span class="type-name">Wright</span><span class="whitespace"> </span>(2006)<span class="symbol">.</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">c1</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span>0001</span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">c2</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span>9</span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">a_max</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">1<span class="symbol">.</span></span></span><span class="whitespace">

  </span><span class="code-span"><span class="code-span-leaf">f_0</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">g_0</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">grad</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span></span></span></span><span class="whitespace">

  </span><span class="code-span"><span class="code-span-leaf">a_ref</span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span>5</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">a_ref_last</span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span></span></span></span><span class="whitespace">

  </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">iter</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span><span class="symbol">\</span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">a_i</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_ref</span></span></span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">a_last</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_ref_last</span></span></span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">f_i</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span></span><span class="whitespace">
    </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;=</span></span><span class="whitespace"> </span><span class="code-span-leaf">maxiter</span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">||</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f_i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">f_0</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">c1</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_i</span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">g_0</span></span></span>)<span class="whitespace"> </span></span></span></span><span class="code-span-leaf"><span class="symbol">||</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span"><span class="code-span-leaf">f_i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;=</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_last<span class="whitespace"> </span></span></span></span><span class="code-span-leaf"><span class="symbol">&amp;&amp;</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;</span></span><span class="whitespace"> </span><span class="code-span-leaf">0</span></span></span>)</span></span><span class="whitespace">
      </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Done</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">zoom</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>a_last<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>a_i<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>c1<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>c2</span></span>)</span></span><span class="whitespace">
      </span><span class="keyword">else</span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">g_i</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">grad</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">abs</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>g_i<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">&lt;=</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span"><span class="symbol">-</span><span class="code-span-leaf">c2</span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">g_0</span></span>)</span></span><span class="whitespace">
          </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Done</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span><span class="whitespace">
          </span><span class="keyword">else</span><span class="whitespace">
            </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">g_i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;=</span></span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span></span></span><span class="whitespace">
              </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Done</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">zoom</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>a_i<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>a_last<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>c1<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>c2</span></span>)</span></span><span class="whitespace">
              </span><span class="keyword">else</span><span class="whitespace">
                </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">a_ref_last</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_i</span></span></span><span class="whitespace">
                </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">a_ref</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">0<span class="symbol">.</span>5</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">a_i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_max</span></span>)</span></span></span></span><span class="whitespace">
                </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Continue</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>backtracking_line_search(<span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">maxiter</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Nat</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">f</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span-leaf"><span class="type-name">Float</span></span>)</span><span class="code-span-leaf"><span class="symbol">-&gt;</span></span></span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace">
  </span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="comment">-- Algorithm 3.1 in Nocedal and Wright (2006).</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">a_init</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">1<span class="symbol">.</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">f_0</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">g_0</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">grad</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">rho</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span>5</span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">c</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span>0001</span></span><span class="whitespace">

  </span><span class="code-span"><span class="code-span-leaf">a_ref</span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_init</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">iter</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span><span class="symbol">\</span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">a_i</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_ref</span></span></span><span class="whitespace">
    </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">f</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_i<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">&lt;=</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">f_0</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">c</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">a_i</span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">g_0</span></span></span>)<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">||</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;=</span></span><span class="whitespace"> </span><span class="code-span-leaf">maxiter</span></span></span><span class="whitespace">
      </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Done</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>a_i</span></span><span class="whitespace">
      </span><span class="keyword">else</span><span class="whitespace">
        </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">a_ref</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">a_i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">rho</span></span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Continue</span></span></span></span></span></span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">struct</span><span class="whitespace"> </span><span class="type-name">BFGSresults</span>(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span>)<span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span>fval<span class="whitespace"> </span><span class="symbol">:</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace">
  </span>x_opt<span class="symbol">:</span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span>)</span><span class="whitespace">
  </span>error<span class="symbol">:</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace">
  </span>num_iter<span class="symbol">:</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Nat</span></span><span class="whitespace">
</span></span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>bfgs_minimize(<span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">f</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span>)</span><span class="code-span-leaf"><span class="symbol">-&gt;</span></span></span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="symbol">,</span><span class="whitespace">                 </span><span class="symbol">--</span><span class="type-name">Objective</span><span class="whitespace"> </span>function<span class="symbol">.</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">x0</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span><span class="symbol">,</span><span class="whitespace">                       </span><span class="symbol">--</span><span class="type-name">Initial</span><span class="whitespace"> </span>point<span class="symbol">.</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">H0</span></span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span></span><span class="symbol">,</span><span class="whitespace">                    </span><span class="symbol">--</span><span class="type-name">Initial</span><span class="whitespace"> </span>inverse<span class="whitespace"> </span><span class="type-name">Hessian</span><span class="whitespace"> </span>approximation<span class="symbol">.</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">linesearch</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span">(<span class="code-span-leaf"><span class="type-name">Float</span></span>)</span><span class="code-span-leaf"><span class="symbol">-&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span>)</span><span class="code-span-leaf"><span class="symbol">-&gt;</span></span></span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="symbol">,</span><span class="whitespace">  </span><span class="symbol">--</span><span class="type-name">Line</span><span class="whitespace"> </span>search<span class="whitespace"> </span>that<span class="whitespace"> </span>returns<span class="whitespace"> </span>a<span class="whitespace"> </span>step<span class="whitespace"> </span>size<span class="symbol">.</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">tol</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span></span><span class="symbol">,</span><span class="whitespace">                         </span><span class="symbol">--</span><span class="type-name">Convergence</span><span class="whitespace"> </span>tolerance<span class="whitespace"> </span>(<span class="keyword">of</span><span class="whitespace"> </span>the<span class="whitespace"> </span>gradient<span class="whitespace"> </span><span class="type-name">L2</span><span class="whitespace"> </span>norm)<span class="symbol">.</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">maxiter</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Nat</span><span class="whitespace">                        </span><span class="symbol">--</span><span class="type-name">Maximum</span><span class="whitespace"> </span>number<span class="whitespace"> </span><span class="keyword">of</span><span class="whitespace"> </span><span class="type-name">BFGS</span><span class="whitespace"> </span>iterations<span class="symbol">.</span></span><span class="whitespace">
  </span></span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">BFGSresults</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>n<span class="whitespace"> </span></span></span><span class="keyword">given</span><span class="whitespace"> </span>(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span>)<span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="comment">-- Algorithm 6.1 in Nocedal and Wright (2006).</span><span class="whitespace">

  </span><span class="code-span"><span class="code-span-leaf">xref</span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>x0</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Href</span></span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span><span class="type-name">H0</span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">gref</span><span class="whitespace"> </span><span class="symbol">&lt;-</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="keyword">with</span>_state</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span"><span class="code-span-leaf">grad</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>x0</span></span>)</span></span></span><span class="whitespace">

  </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">iter</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span><span class="symbol">\</span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">x</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>xref</span></span></span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">g</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>gref</span></span></span><span class="whitespace">
    </span><span class="code-span"><span class="code-span-leaf">grad_norm</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">sqrt</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">$</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">sum</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">$</span></span><span class="whitespace"> </span><span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">g</span><span class="code-span">[<span class="code-span-leaf">i</span>]<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">g</span><span class="code-span">[<span class="code-span-leaf">i</span>]</span></span></span></span></span></span></span><span class="whitespace">

    </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">grad_norm</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&lt;</span></span><span class="whitespace"> </span><span class="code-span-leaf">tol</span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">||</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">i</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">&gt;=</span></span><span class="whitespace"> </span><span class="code-span-leaf">maxiter</span></span></span><span class="whitespace">
      </span><span class="keyword">then</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Done</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf"></span><span class="type-name">BFGSresults</span></span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">f</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>x</span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span-leaf">x</span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span-leaf">grad_norm</span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span-leaf">i</span>)</span></span></span><span class="whitespace">
      </span><span class="keyword">else</span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">H</span></span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">get</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span><span class="type-name">Href</span></span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">search_direction</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="symbol">-</span><span class="code-span-leaf"><span class="type-name">H</span></span></span><span class="code-span-leaf"><span class="symbol">**.</span></span><span class="code-span-leaf">g</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">f_line</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="symbol">\</span><span class="code-span"><span class="code-span-leaf">s</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">f</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">x</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">s</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">.*</span></span><span class="whitespace"> </span><span class="code-span-leaf">search_direction</span></span></span>)</span></span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">step_size</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">linesearch</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f_line</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">x_diff</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">step_size</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">.*</span></span><span class="whitespace"> </span><span class="code-span-leaf">search_direction</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">x_next</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">x</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span-leaf">x_diff</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">g_next</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">grad</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>f<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>x_next</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">grad_diff</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">g_next</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">-</span></span><span class="whitespace"> </span><span class="code-span-leaf">g</span></span></span><span class="whitespace">

        </span><span class="comment">-- Update the inverse Hessian approximation.</span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf">rho_inv</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">vdot</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>grad_diff<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>x_diff</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span"><span class="keyword">if</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">not</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">rho_inv</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">==</span></span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span></span></span>)</span></span><span class="whitespace">
            </span><span class="keyword">then</span><span class="whitespace">
                </span><span class="code-span"><span class="code-span-leaf">rho</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">1<span class="symbol">.</span></span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">/</span></span><span class="whitespace"> </span><span class="code-span-leaf">rho_inv</span></span></span><span class="whitespace">
                </span><span class="code-span"><span class="code-span-leaf">y</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">eye</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">-</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">rho</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">.*</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">outer_product</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>x_diff<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>grad_diff</span></span></span></span>)</span></span><span class="whitespace">
                </span><span class="code-span"><span class="code-span"><span class="code-span-leaf"><span class="type-name">Href</span></span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">y</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">**</span></span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">H</span></span><span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">**</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf">transpose</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>y</span></span>)<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">rho</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">.*</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">outer_product</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>x_diff<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>x_diff</span></span></span></span></span></span></span></span><span class="whitespace">

        </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">xref</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span-leaf">x_next</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">gref</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:=</span></span><span class="whitespace"> </span><span class="code-span-leaf">g_next</span></span></span><span class="whitespace">
        </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Continue</span></span></span></span></span></span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">

</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>rosenbrock(<span class="code-span"><span class="code-span-leaf">coord</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span"><span class="code-span">(<span class="code-span"><span class="code-span-leaf"><span class="type-name">Fin</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>2</span></span>)</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="symbol">--</span><span class="type-name">A</span><span class="whitespace"> </span>standard<span class="whitespace"> </span>optimization<span class="whitespace"> </span>test<span class="whitespace"> </span><span class="keyword">case</span>;<span class="whitespace"> </span>the<span class="whitespace"> </span>optimum<span class="whitespace"> </span>is<span class="whitespace"> </span>(1<span class="symbol">,</span><span class="whitespace"> </span>1)<span class="symbol">.</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">x</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">coord</span><span class="code-span">[<span class="code-span"><span class="code-span-leaf">0</span><span class="code-span-leaf"><span class="symbol">@</span></span><span class="code-span-leaf">_</span></span>]</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">y</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">coord</span><span class="code-span">[<span class="code-span"><span class="code-span-leaf">1</span><span class="code-span-leaf"><span class="symbol">@</span></span><span class="code-span-leaf">_</span></span>]</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">pow</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">1</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">-</span></span><span class="whitespace"> </span><span class="code-span-leaf">x</span></span>)<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>2<span class="whitespace"> </span></span></span><span class="code-span-leaf"><span class="symbol">+</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">100</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">pow</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">y</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">-</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">x</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">*</span></span><span class="whitespace"> </span><span class="code-span-leaf">x</span></span></span>)<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>2</span></span></span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span">%time<span class="whitespace">
</span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">bfgs_minimize</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>rosenbrock<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>[<span class="code-span-leaf">10<span class="symbol">.</span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span-leaf">10<span class="symbol">.</span></span>]<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>eye<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="symbol">\</span><span class="code-span-leaf">f</span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">backtracking_line_search</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>15<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>f</span></span></span>)<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>0<span class="symbol">.</span>001<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>100</span></span><span class="whitespace">
</span></span></div><div class="result-block">BFGSresults(1.741236e-11, [0.9999971, 0.9999939], 0.0001280856, 46)</div><div class="result-block">
Compile time: 1.196 s
Run time:     530.500 us </div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="symbol">@</span>noinline<span class="whitespace">
</span><span class="keyword">def</span><span class="whitespace"> </span>multiclass_logistic_loss(<span class="code-span"><span class="code-span-leaf">xs</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span"><span class="code-span-leaf">d</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">ys</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf">m</span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">w</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span">(<span class="code-span-leaf">d</span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span-leaf">m</span>)</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace"> </span><span class="keyword">given</span><span class="whitespace"> </span>(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">d</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">m</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span>)<span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">w_arr</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">i</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf">d</span></span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">j</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf">m</span></span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">w</span><span class="code-span">[<span class="code-span">(<span class="code-span-leaf">i</span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span-leaf">j</span>)</span>]</span></span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">logits</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">xs</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">**</span></span><span class="whitespace"> </span><span class="code-span-leaf">w_arr</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">logit_at_label</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">logits</span><span class="code-span">[<span class="code-span-leaf">i</span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">ys</span><span class="code-span">[<span class="code-span-leaf">i</span>]</span></span>]</span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">per_example_loss</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">logsumexp</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf"></span>logits</span><span class="code-span">[<span class="code-span-leaf">i</span>]<span class="whitespace"> </span></span></span></span><span class="code-span-leaf"><span class="symbol">-</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">logit_at_label</span><span class="code-span">[<span class="code-span-leaf">i</span>]</span></span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">mean</span><span class="code-span">(<span class="code-span-leaf">per_example_loss</span>)</span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>multiclass_logreg(<span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">xs</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span"><span class="code-span-leaf">d</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">ys</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf">m</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">maxiter</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Nat</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">maxls</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Nat</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">tol</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace"> </span><span class="keyword">given</span><span class="whitespace"> </span>(<span class="code-span"><span class="code-span-leaf">n</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">d</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf">m</span><span class="code-span-leaf"><span class="symbol">|</span></span><span class="code-span-leaf"><span class="type-name">Ix</span></span></span>)<span class="symbol">=</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">ob_fun</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="symbol">\</span><span class="code-span-leaf">v</span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">multiclass_logistic_loss</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>xs<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>ys<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>v</span></span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">w0</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">zero</span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">res</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">bfgs_minimize</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>ob_fun<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>w0<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>eye<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="symbol">\</span><span class="code-span-leaf">f</span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">zoom_line_search</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>maxls<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>f</span></span></span>)<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>tol<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>maxiter</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">res</span><span class="symbol">.</span><span class="code-span-leaf">fval</span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- Define a version of `multiclass_logreg` with Int instead of Nat labels, callable from Python
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- (see benchmarks/bfgs.py).
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="keyword">def</span><span class="whitespace"> </span>multiclass_logreg_int(<span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">xs</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span"><span class="code-span">(<span class="code-span"><span class="code-span-leaf"><span class="type-name">Fin</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>n</span></span>)</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span"><span class="code-span">(<span class="code-span"><span class="code-span-leaf"><span class="type-name">Fin</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>d</span></span>)</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">ys</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span"><span class="code-span">(<span class="code-span"><span class="code-span-leaf"><span class="type-name">Fin</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>n</span></span>)</span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="code-span-leaf"><span class="type-name">Int</span></span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">num_classes</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Int</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">maxiter</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Int</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">maxls</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Int</span></span></span><span class="symbol">,</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">tol</span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="code-span-leaf"><span class="type-name">Float</span></span></span>)<span class="whitespace"> </span><span class="symbol">-&gt;</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="type-name">Float</span></span><span class="whitespace"> </span><span class="keyword">given</span><span class="whitespace"> </span>(<span class="code-span-leaf">n</span><span class="symbol">,</span><span class="whitespace"> </span><span class="code-span-leaf">d</span>)<span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace">
  </span><span class="code-span"><span class="code-span-leaf">y_ind</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"><span class="type-name">Fin</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">i32_to_n</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>num_classes</span></span>)</span></span></span><span class="whitespace">
  </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">multiclass_logreg</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>xs<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="keyword">for</span><span class="whitespace"> </span><span class="code-span-leaf">i</span><span class="symbol">.</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf">i32_to_n</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span-leaf"></span>ys</span><span class="code-span">[<span class="code-span-leaf">i</span>]<span class="whitespace"> </span></span></span></span><span class="code-span-leaf"><span class="symbol">@</span></span><span class="whitespace"> </span><span class="code-span-leaf">y_ind</span></span></span>)<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">i32_to_n</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>maxiter</span></span>)<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">i32_to_n</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>maxls</span></span>)<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>tol</span></span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span-leaf">n_samples</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">100</span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span-leaf">n_features</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">20</span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span-leaf">n_classes</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">5</span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span-leaf">maxiter</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">30</span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span-leaf">maxls</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">15</span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span-leaf">tol</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span-leaf">0<span class="symbol">.</span>001</span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span-leaf">xs</span><span class="whitespace"> </span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">rand_mat</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>n_samples<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>n_features<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>randn<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">new_key</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>0</span></span>)</span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">ys</span><span class="whitespace"> </span><span class="code-span-leaf"><span class="symbol">:</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span">(<span class="code-span"><span class="code-span-leaf"><span class="type-name">Fin</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>n_samples</span></span>)<span class="whitespace"> </span></span><span class="code-span-leaf"><span class="symbol">=&gt;</span></span><span class="whitespace"> </span><span class="code-span">(<span class="code-span"><span class="code-span-leaf"><span class="type-name">Fin</span></span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>n_classes</span></span>)<span class="whitespace"> </span></span></span></span><span class="symbol">=</span><span class="whitespace"> </span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">rand_vec</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>n_samples<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>rand_idx<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>(<span class="code-span"><span class="code-span-leaf">new_key</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>1</span></span>)</span></span></span><span class="whitespace">
</span></span></div></div><div class="cell"><div class="code-block"><span class="whitespace">
</span></div></div><div class="cell"><div class="code-block"><span class="code-span">%time<span class="whitespace">
</span><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span"><span class="code-span-leaf">multiclass_logreg</span><span class="whitespace"> </span><span class="code-span"><span class="code-span-leaf"></span>xs<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>ys<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>maxiter<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>maxls<span class="whitespace"> </span></span></span><span class="code-span"><span class="code-span-leaf"></span>tol</span></span><span class="whitespace">
</span></span></div><div class="result-block">1.609437</div><div class="result-block">
Compile time: 5.951 s
Run time:     503.300 us </div></div></div></body></html>