<!DOCTYPE HTML>
<html><head><style type="text/css">/* Copyright 2019 Google LLC                              */
/*                                                        */
/* Use of this source code is governed by a BSD-style     */
/* license that can be found in the LICENSE file or at    */
/* https://developers.google.com/open-source/licenses/bsd */

body {
  margin: 1em auto 1em auto;
  padding: 1em 1em 1em 1em;
  max-width: 50em;
  font-family: Helvetica, sans-serif;
  font-size: 100%;
  color: #333;
  padding-bottom: 500px;
}

.cell {
}

.code-block, .err-block, .result-block {
  padding: 0em 0em 0em 2em;
  display: block;
  font-family: monospace;
  white-space: pre;
}

code {
  background-color: #F0F0F0;
}

.result-block {
  border-left: 3px solid  #87CEFA;
}

.prose-block {
  line-height: 140%;
}

.err-block {
  font-weight: bold;
  color: #B22222;
  border-left: 3px solid #B22222;
}

.plot {
  padding: 5em;
}

.plot-img {
  width: 80%;
}

.comment {
  color: #808080;
}

.keyword {
  color: #0000DD;
}

.command {
  color: #A80000;
}

.symbol {
  color: #E07000;
}

.type-name {
  color: #A80000;
}

.iso-sugar {
  color: #25BBA7;
}
</style><meta charset="UTF-8"></head><body><div id="main-output"><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Distribution</span> (range<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span>
  ( <span class="type-name">Key</span> <span class="symbol">-&gt;</span> range
  <span class="symbol">&amp;</span> range <span class="symbol">-&gt;</span> <span class="type-name">Float</span>)  <span class="comment">-- log prob
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Model</span> (state<span class="symbol">:</span><span class="type-name">Type</span>) (observation<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span>
  ( <span class="type-name">Distribution</span> state                   <span class="comment">-- initial state
</span>  <span class="symbol">&amp;</span> state <span class="symbol">-&gt;</span> <span class="type-name">Distribution</span> state          <span class="comment">-- dynamics
</span>  <span class="symbol">&amp;</span> state <span class="symbol">-&gt;</span> <span class="type-name">Distribution</span> observation)   <span class="comment">-- observations
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sample (d<span class="symbol">:</span> <span class="type-name">Distribution</span> a) (k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  (sampler<span class="symbol">,</span> _) <span class="symbol">=</span> d
  sampler k
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> simulate (model<span class="symbol">:</span> <span class="type-name">Model</span> s v) (t<span class="symbol">:</span> <span class="type-name">Int</span>) (key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> t<span class="symbol">=&gt;</span>(s <span class="symbol">&amp;</span> v) <span class="symbol">=</span>
  (init<span class="symbol">,</span> dynamics<span class="symbol">,</span> observe) <span class="symbol">=</span> model
  [key<span class="symbol">,</span> subkey] <span class="symbol">=</span> splitKey key
  s0 <span class="symbol">=</span> sample init subkey
  withState s0 <span class="symbol">\</span>s_ref <span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span>
      [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> splitKey (ixkey key i)
      s <span class="symbol">=</span> get s_ref
      s_next <span class="symbol">=</span> sample (dynamics s) k1
      v <span class="symbol">=</span> sample (observe s) k2
      s_ref <span class="symbol">:=</span> s_next
      (s<span class="symbol">,</span> v)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> filter
    (num_particles<span class="symbol">:</span> <span class="type-name">Int</span>) (num_timesteps<span class="symbol">:</span> <span class="type-name">Int</span>)
    (model<span class="symbol">:</span> <span class="type-name">Model</span> s v)
    (summarize<span class="symbol">:</span> (<span class="type-name">Fin</span> num_particles <span class="symbol">=&gt;</span> s) <span class="symbol">-&gt;</span> a)
    (obs<span class="symbol">:</span> <span class="type-name">Fin</span> num_timesteps<span class="symbol">=&gt;</span>v)
    (key<span class="symbol">:</span> <span class="type-name">Key</span>)
    <span class="symbol">:</span> <span class="type-name">Fin</span> num_timesteps <span class="symbol">=&gt;</span> a <span class="symbol">=</span>
  (init<span class="symbol">,</span> dynamics<span class="symbol">,</span> observe) <span class="symbol">=</span> model
  [key<span class="symbol">,</span> init_key] <span class="symbol">=</span> splitKey key
  init_particles <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">:</span> (<span class="type-name">Fin</span> num_particles)<span class="symbol">.</span> sample init (ixkey init_key i)
  withState init_particles <span class="symbol">\</span>p_ref <span class="symbol">.</span>
    <span class="keyword">for</span> t<span class="symbol">:</span> (<span class="type-name">Fin</span> num_timesteps)<span class="symbol">.</span>
      p_prev <span class="symbol">=</span> get p_ref
      logLikelihoods <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> snd (observe p_prev<span class="symbol">.</span>i) obs<span class="symbol">.</span>t
      [resample_key<span class="symbol">,</span> dynamics_key] <span class="symbol">=</span> splitKey (ixkey key t)
      resampled_idxs <span class="symbol">=</span> categoricalBatch logLikelihoods resample_key
      p_resampled <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> p_prev<span class="symbol">.</span>(resampled_idxs<span class="symbol">.</span>i)
      p_next <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> fst (dynamics p_resampled<span class="symbol">.</span>i) (ixkey dynamics_key i)
      p_ref <span class="symbol">:=</span> p_next
      summarize p_resampled
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> normalDistn (mean<span class="symbol">:</span> <span class="type-name">Float</span>) (var<span class="symbol">:</span> <span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Distribution</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  ( <span class="symbol">\</span>k<span class="symbol">.</span> (randn k) <span class="symbol">*</span> (sqrt var) <span class="symbol">+</span> mean
  <span class="symbol">,</span> <span class="symbol">\</span>v<span class="symbol">.</span> <span class="symbol">-</span>0<span class="symbol">.</span>5 <span class="symbol">*</span> (sq (v <span class="symbol">-</span> mean)) <span class="symbol">/</span> var <span class="symbol">-</span> 0<span class="symbol">.</span>5 <span class="symbol">*</span> log (2<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">*</span> var)
  )
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">gaussModel <span class="symbol">:</span> <span class="type-name">Model</span> <span class="type-name">Float</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  ( normalDistn 0<span class="symbol">.</span>1 0<span class="symbol">.</span>1
  <span class="symbol">,</span> <span class="symbol">\</span>s<span class="symbol">.</span> normalDistn s 1<span class="symbol">.</span>0
  <span class="symbol">,</span> <span class="symbol">\</span>s<span class="symbol">.</span> normalDistn s 1<span class="symbol">.</span>0
  )
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">timesteps <span class="symbol">=</span> 10
</div></div><div class="cell"><div class="code-block">num_particles <span class="symbol">=</span> 10000
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">truth <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> timesteps)<span class="symbol">.</span>
  s <span class="symbol">=</span> <span class="type-name">IToF</span> (ordinal i)
  (s<span class="symbol">,</span> sample (normalDistn s 1<span class="symbol">.</span>0) <span class="symbol">$</span> ixkey (newKey 0) i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">filtered <span class="symbol">=</span> filter num_particles _ gaussModel mean (map snd truth) (newKey 0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- :p for i. (truth.i, filtered.i)
</span></div></div></div></body></html>